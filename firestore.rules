rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // í—¬í¼ í•¨ìˆ˜: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // í—¬í¼ í•¨ìˆ˜: ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    function isAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email == 'gostepexercise@gmail.com' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin');
    }
    
    // í—¬í¼ í•¨ìˆ˜: ë¬¸ì„œ ì†Œìœ ì í™•ì¸
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // í—¬í¼ í•¨ìˆ˜: ì‚¬ìš©ì ê²€ì¦ëœ ìƒíƒœ í™•ì¸
    function isVerified() {
      return request.auth.token.email_verified == true;
    }
    
    // ì‚¬ìš©ì ì»¬ë ‰ì…˜ ê·œì¹™
    match /users/{userId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ë¬¸ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isOwner(userId) || isAdmin();
  
    // ìƒì„±: ê´€ë¦¬ìëŠ” ëª¨ë“  ì‚¬ìš©ì ë¬¸ì„œ ìƒì„± ê°€ëŠ¥, ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ ë¬¸ì„œë§Œ
    allow create: if isAdmin() || 
      (isAuthenticated() && 
        request.auth.uid == userId &&
        request.auth.token.email_verified == true);
  
    // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ë¬¸ì„œ ë˜ëŠ” ê´€ë¦¬ì
    allow update: if (isOwner(userId) || isAdmin()) &&
      // ì‚¬ìš©ìëŠ” ìì‹ ì˜ userTypeì„ ë³€ê²½í•  ìˆ˜ ì—†ìŒ (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
      (!request.auth.uid == userId || 
       !('userType' in request.resource.data) || 
       request.resource.data.userType == resource.data.userType);

    // ì‚­ì œ: ê´€ë¦¬ìë§Œ ê°€ëŠ¥
    allow delete: if isAdmin();
    }
    
    // ğŸ”§ FIXED: ì‚¬ìš©ì ì•½ê´€ ë™ì˜ ì»¬ë ‰ì…˜ ê·œì¹™ (ê°„ì†Œí™”)
    match /user_agreements/{userId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì•½ê´€ ë™ì˜ ì •ë³´ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isOwner(userId) || isAdmin();
      
      // ìƒì„±/ì—…ë°ì´íŠ¸: ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ ì•½ê´€ ë™ì˜ (ê²€ì¦ ì¡°ê±´ ì™„í™”)
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ê²Œì‹œíŒ ê³µì§€ì‚¬í•­ ì»¬ë ‰ì…˜ ê·œì¹™
    match /board_notice/{noticeId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê²Œì‹œíŒ ì¹¼ëŸ¼ ì»¬ë ‰ì…˜ ê·œì¹™
    match /board_column/{columnId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê²Œì‹œíŒ ê°•ì˜ìë£Œ ì»¬ë ‰ì…˜ ê·œì¹™
    match /board_materials/{materialId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê²Œì‹œíŒ ë™ì˜ìƒ ê°•ì˜ ì»¬ë ‰ì…˜ ê·œì¹™
    match /board_videos/{videoId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê³µì§€ì‚¬í•­ ì»¬ë ‰ì…˜ ê·œì¹™
    match /notices/{noticeId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ì¹¼ëŸ¼ ì»¬ë ‰ì…˜ ê·œì¹™
    match /columns/{columnId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê°•ì˜ìë£Œ ì»¬ë ‰ì…˜ ê·œì¹™
    match /materials/{materialId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ë™ì˜ìƒ ê°•ì˜ ì»¬ë ‰ì…˜ ê·œì¹™
    match /videos/{videoId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨)
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // êµìœ¡ê³¼ì • ì»¬ë ‰ì…˜ ê·œì¹™
    match /courses/{courseId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨) - êµìœ¡ ì‹ ì²­ í˜ì´ì§€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê°•ì‚¬ ì •ë³´ ì»¬ë ‰ì…˜ ê·œì¹™
    match /instructors/{instructorId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨) - ê°•ì‚¬ ì†Œê°œ í˜ì´ì§€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ì„¤ì • ì»¬ë ‰ì…˜ ê·œì¹™
    match /settings/{settingId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì (ë¹„ë¡œê·¸ì¸ í¬í•¨) - ê°€ê²© ì •ë³´ ë“± ê³µê°œ
      allow read: if true;
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ìê²©ì¦ ì»¬ë ‰ì…˜ ê·œì¹™
    match /certificates/{certId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ìê²©ì¦ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());

      // ğŸ”§ ìˆ˜ì •: ìƒì„±ì€ ì¸ì¦ëœ ì‚¬ìš©ìë„ ê°€ëŠ¥ (ìì‹ ì˜ ì‹ ì²­ë§Œ)
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;

      // ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();  
    }

    // ğŸ”§ FIXED: ì‹ ì²­ì„œ ì»¬ë ‰ì…˜ ê·œì¹™ (ëŒ€í­ ê°„ì†Œí™”)
    match /applications/{applicationId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ğŸ¯ ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ì‹ ì²­ ê°€ëŠ¥ (ê²€ì¦ ì¡°ê±´ ëŒ€í­ ì™„í™”)
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ğŸ”§ NEW: ê²°ì œ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ ì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /pending_applications/{applicationId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ìƒì„± ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ğŸ”§ NEW: ê²°ì œ ì‹¤íŒ¨ ë¡œê·¸ ì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /payment_failures/{failureId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì‹¤íŒ¨ ë¡œê·¸ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ìƒì„± ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow update, delete: if isAdmin();
    }
    
    // ìˆ˜ê°•ì‹ ì²­ ì»¬ë ‰ì…˜ ê·œì¹™
    match /course_applications/{applicationId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ìˆ˜ê°•ì‹ ì²­ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ğŸ¯ ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ì‹ ì²­ ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ìˆ˜ê°•ì‹ ì²­ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ìê²©ì¦ ì‹ ì²­ ì»¬ë ‰ì…˜ ê·œì¹™
    match /certificate_applications/{applicationId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ğŸ¯ ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ì‹ ì²­ ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ì‹ ì²­ì„œ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ìˆ˜ê°•ì‹ ì²­ ì»¬ë ‰ì…˜ ê·œì¹™ (ê¸°ì¡´)
    match /enrollments/{enrollmentId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ìˆ˜ê°•ì‹ ì²­ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ğŸ¯ ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìë¼ë©´ ëˆ„êµ¬ë‚˜ ì‹ ì²­ ê°€ëŠ¥
      allow create: if isAuthenticated();
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ì˜ ìˆ˜ê°•ì‹ ì²­ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ì‹œí—˜ê²°ê³¼ ì»¬ë ‰ì…˜ ê·œì¹™
    match /examResults/{resultId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ì‹œí—˜ê²°ê³¼ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow create, update, delete: if isAdmin();
    }
    
    // ê²°ì œ ì»¬ë ‰ì…˜ ê·œì¹™
    match /payments/{paymentId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ê²°ì œì •ë³´ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ ê²°ì œì •ë³´
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // ì—…ë°ì´íŠ¸: ê´€ë¦¬ìë§Œ (ê²°ì œ ìƒíƒœ ë³€ê²½)
      allow update: if isAdmin();
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ê¸°ë³¸ ê±°ë¶€ ê·œì¹™ (ìœ„ì— ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ëª¨ë“  ë¬¸ì„œëŠ” ì ‘ê·¼ ë¶ˆê°€)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}