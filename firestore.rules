rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ===================================
    
    // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
    function isAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email == 'gostepexercise@gmail.com' ||
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin'));
    }
    
    // ë¬¸ì„œ ì†Œìœ ì í™•ì¸
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ===================================
    // ì‚¬ìš©ì(users) ì»¬ë ‰ì…˜
    // ===================================
    match /users/{userId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ì‚­ì œëœ ë¬¸ì„œëŠ” ê´€ë¦¬ìë§Œ)
      allow read: if (isOwner(userId) && 
                     (!resource.data.keys().hasAny(['status']) || 
                      resource.data.status != 'deleted')) || 
                     isAdmin();
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ ë¬¸ì„œ ìƒì„± (âœ… ì´ë©”ì¼ ì¸ì¦ ì¡°ê±´ ì œê±°!)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (userTypeì€ ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥)
      allow update: if (isOwner(userId) || isAdmin()) &&
        (isAdmin() || 
         !('userType' in request.resource.data) || 
         request.resource.data.userType == resource.data.userType);
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ì•½ê´€ ë™ì˜(user_agreements) ì»¬ë ‰ì…˜
    // ===================================
    match /user_agreements/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAdmin();
    }
    
    // ===================================
    // êµìœ¡ê³¼ì •(courses) ì»¬ë ‰ì…˜
    // ===================================
    match /courses/{courseId} {
      allow read: if true;  // ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê°•ì‚¬ ì •ë³´(instructors) ì»¬ë ‰ì…˜
    // ===================================
    match /instructors/{instructorId} {
      allow read: if true;  // ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ìˆ˜ê°•ì‹ ì²­(enrollments) ì»¬ë ‰ì…˜
    // ===================================
    match /enrollments/{enrollmentId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ì‚­ì œëœ ê²ƒì€ ê´€ë¦¬ìë§Œ)
      allow read: if isAuthenticated() && 
        ((resource.data.userId == request.auth.uid && 
          (!resource.data.keys().hasAny(['status']) || 
           resource.data.status != 'deleted')) || 
         isAdmin());
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ ìˆ˜ê°•ì‹ ì²­
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // ì—…ë°ì´íŠ¸: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ìê²©ì¦(certificates) ì»¬ë ‰ì…˜
    // ===================================
    match /certificates/{certId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (ì‚­ì œëœ ê²ƒì€ ê´€ë¦¬ìë§Œ)
      allow read: if isAuthenticated() && 
        ((resource.data.userId == request.auth.uid && 
          (!resource.data.keys().hasAny(['status']) || 
            resource.data.status != 'deleted')) || 
         isAdmin());

      // ğŸ”§ ê°œì„ ëœ ìƒì„± ê·œì¹™
      allow create: if isAdmin() || 
        (isAuthenticated() && 
         request.resource.data.userId == request.auth.uid &&
         // ì‹ ì²­ ìƒíƒœë¡œë§Œ ìƒì„± ê°€ëŠ¥
         (request.resource.data.status == 'pending' || 
          request.resource.data.status == 'submitted') &&
         // ë°œê¸‰ ê´€ë ¨ í•„ë“œëŠ” ì—†ê±°ë‚˜ falseì—¬ì•¼ í•¨
         (!request.resource.data.keys().hasAny(['isIssued']) || 
          request.resource.data.isIssued == false) &&
         // ìê²©ì¦ ë²ˆí˜¸ëŠ” ì—†ì–´ì•¼ í•¨ (ê´€ë¦¬ìê°€ ë°œê¸‰ ì‹œ ìƒì„±)
         (!request.resource.data.keys().hasAny(['certificateNumber']) || 
          request.resource.data.certificateNumber == null ||
          request.resource.data.certificateNumber.matches('CERT_.*|PENDING.*')));
  
      // ì—…ë°ì´íŠ¸: ê´€ë¦¬ìë§Œ
      allow update: if isAdmin();
  
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ì‹ ì²­ì„œ(applications) ì»¬ë ‰ì…˜
    // ===================================
    match /applications/{applicationId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­(pending_applications) ì»¬ë ‰ì…˜
    // ===================================
    match /pending_applications/{applicationId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ê²°ì œ ì‹¤íŒ¨ ë¡œê·¸(payment_failures) ì»¬ë ‰ì…˜
    // ===================================
    match /payment_failures/{failureId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ===================================
    // ê²°ì œ(payments) ì»¬ë ‰ì…˜
    // ===================================
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ===================================
    // ì‹œí—˜ê²°ê³¼(examResults) ì»¬ë ‰ì…˜
    // ===================================
    match /examResults/{resultId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ì„¤ì •(settings) ì»¬ë ‰ì…˜
    // ===================================
    match /settings/{settingId} {
      allow read: if true;  // ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê²Œì‹œíŒ - ê³µì§€ì‚¬í•­(board_notice) ì»¬ë ‰ì…˜
    // ===================================
    match /board_notice/{noticeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê²Œì‹œíŒ - ì¹¼ëŸ¼(board_column) ì»¬ë ‰ì…˜
    // ===================================
    match /board_column/{columnId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê²Œì‹œíŒ - ê°•ì˜ìë£Œ(board_materials) ì»¬ë ‰ì…˜
    // ===================================
    match /board_materials/{materialId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê²Œì‹œíŒ - ë™ì˜ìƒ(board_videos) ì»¬ë ‰ì…˜
    // ===================================
    match /board_videos/{videoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê³µì§€ì‚¬í•­(notices) ì»¬ë ‰ì…˜
    // ===================================
    match /notices/{noticeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ì¹¼ëŸ¼(columns) ì»¬ë ‰ì…˜
    // ===================================
    match /columns/{columnId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê°•ì˜ìë£Œ(materials) ì»¬ë ‰ì…˜
    // ===================================
    match /materials/{materialId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ë™ì˜ìƒ(videos) ì»¬ë ‰ì…˜
    // ===================================
    match /videos/{videoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ===================================
    // ê¸°ë³¸ ê±°ë¶€ ê·œì¹™
    // ===================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}