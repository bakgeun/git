/**
 * cert-management.js - PDF ì•„ì´ì½˜ êµì²´ ë° ë“œë¡­ë‹¤ìš´ z-index ë¬¸ì œ í•´ê²°
 * ì™„ì „í•œ í†µí•© ìœ í‹¸ë¦¬í‹° ì‹œìŠ¤í…œ ì ìš© ë²„ì „ (ë¬¸ì œ í•´ê²°)
 */

console.log('=== PDF ì•„ì´ì½˜ ìˆ˜ì •ëœ cert-management.js íŒŒì¼ ë¡œë“œë¨ ===');

// ğŸ”§ ì˜ì¡´ì„± ì²´í¬ ì‹œìŠ¤í…œ
function checkDependencies() {
    const requiredUtils = [
        { name: 'window.formatters', path: 'formatters.js' },
        { name: 'window.dateUtils', path: 'date-utils.js' }
        // validators.jsì™€ dom-utils.jsëŠ” ì‹¤ì œë¡œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°
    ];

    const missing = [];

    requiredUtils.forEach(util => {
        if (!eval(util.name)) {
            missing.push(util);
        }
    });

    if (missing.length > 0) {
        console.error('âš ï¸ í•„ìˆ˜ ìœ í‹¸ë¦¬í‹°ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ:', missing.map(m => m.path));
        console.log('ğŸ“ HTMLì—ì„œ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë“¤ì´ ë¨¼ì € ë¡œë“œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:');
        missing.forEach(m => {
            console.log(`   <script src="{basePath}assets/js/utils/${m.path}"></script>`);
        });
        return false;
    }

    console.log('âœ… ëª¨ë“  í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° ë¡œë“œ í™•ì¸ë¨');

    // ğŸ”§ ì¶”ê°€: formatters í•¨ìˆ˜ë“¤ì´ ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
    try {
        const testDate = new Date();
        const testFormatDate = window.formatters.formatDate(testDate, 'YYYY.MM.DD');
        const testFormatCurrency = window.formatters.formatCurrency(350000);

        console.log('âœ… formatters.formatDate í…ŒìŠ¤íŠ¸ ì„±ê³µ:', testFormatDate);
        console.log('âœ… formatters.formatCurrency í…ŒìŠ¤íŠ¸ ì„±ê³µ:', testFormatCurrency);

        if (!testFormatDate || !testFormatCurrency) {
            throw new Error('í¬ë§·í„° í•¨ìˆ˜ ê²°ê³¼ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

    } catch (error) {
        console.error('âŒ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        return false;
    }

    return true;
}

// ğŸ”§ Firebase ì—°ê²° ìƒíƒœ í™•ì¸
function checkFirebaseConnection() {
    console.log('ğŸ”¥ Firebase ì—°ê²° ìƒíƒœ í™•ì¸...');

    if (!window.dhcFirebase) {
        console.warn('âš ï¸ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ - í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ë™ì‘');
        return { connected: false, reason: 'not_initialized' };
    }

    if (!window.dhcFirebase.db) {
        console.warn('âš ï¸ Firestore ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
        return { connected: false, reason: 'db_not_initialized' };
    }

    console.log('âœ… Firebase ì—°ê²° ìƒíƒœ ì •ìƒ');
    return { connected: true };
}

// DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ì™€ ë¡œë”© ì¤‘ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
function initializeWhenReady() {
    console.log('=== ì´ˆê¸°í™” ì¤€ë¹„, í˜„ì¬ ìƒíƒœ:', document.readyState);

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            console.log('=== DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ ===');
            initCertManagementPage();
        });
    } else {
        console.log('=== DOM ì´ë¯¸ ë¡œë“œë¨, ì¦‰ì‹œ ì´ˆê¸°í™” ===');
        initCertManagementPage();
    }
}

// ì´ˆê¸°í™” ì‹œì‘
initializeWhenReady();

// í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
function initCertManagementPage() {
    console.log('=== initCertManagementPage ì‹¤í–‰ ì‹œì‘ ===');

    try {
        // ğŸ”§ ì˜ì¡´ì„± ì²´í¬ ë¨¼ì € ì‹¤í–‰
        if (!checkDependencies()) {
            console.error('âŒ í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° ëˆ„ë½ìœ¼ë¡œ ì´ˆê¸°í™” ì¤‘ë‹¨');
            showDependencyError();
            return;
        }

        // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
        const firebaseStatus = checkFirebaseConnection();
        if (!firebaseStatus.connected) {
            console.log('ğŸ”§ Firebase ë¯¸ì—°ê²°, í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ê³„ì† ì§„í–‰');
        }

        // ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™”
        initCertManager();

        console.log('=== initCertManagementPage ì™„ë£Œ ===');
    } catch (error) {
        console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    }
}

// ğŸ”§ ì˜ì¡´ì„± ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
function showDependencyError() {
    const tableBody = document.querySelector('#cert-table tbody');

    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-red-500">
                    <div class="text-lg font-semibold mb-2">âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜</div>
                    <p class="text-red-700 mb-4">í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    <p class="text-red-600 text-sm">í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>
                </td>
            </tr>
        `;
    }
}

// =================================
// ìê²©ì¦ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
// =================================

function initCertManager() {
    console.log('ğŸ“ ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™” ì‹œì‘');

    // ì „ì—­ certManager ê°ì²´ ìƒì„±
    window.certManager = {
        currentPage: 1,
        pageSize: 10,
        lastDoc: null,
        currentCertType: 'health-exercise',

        /**
         * ì´ˆê¸°í™”
         */
        init: async function () {
            try {
                console.log('ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™” ì‹œì‘');

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                this.registerEventListeners();

                // ìê²©ì¦ ë°ì´í„° ë¡œë“œ
                await this.loadCertificates();

                console.log('ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                if (window.adminAuth && window.adminAuth.showNotification) {
                    window.adminAuth.showNotification('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                return false;
            }
        },

        /**
         * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
         */
        registerEventListeners: function () {
            // ìê²©ì¦ ë°œê¸‰ í¼ ì œì¶œ ì´ë²¤íŠ¸
            const certIssueForm = document.getElementById('cert-issue-form');
            if (certIssueForm) {
                certIssueForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.issueCertificate(e.target);
                });
            }

            // ìê²©ì¦ ìˆ˜ì • í¼ ì œì¶œ ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
            const certEditForm = document.getElementById('cert-edit-form');
            if (certEditForm) {
                certEditForm.addEventListener('submit', (e) => {
                    this.handleUpdateCertificate(e);
                });
            }

            // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì—”í„°í‚¤ ì´ë²¤íŠ¸
            const searchInputs = document.querySelectorAll('#search-name, #search-cert-number');
            searchInputs.forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.search();
                });
            });

            // ìƒíƒœ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
            const statusFilter = document.getElementById('filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', () => this.search());
            }

            // ì¼ê´„ ë°œê¸‰ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            const bulkFileInput = document.getElementById('bulk-file');
            if (bulkFileInput) {
                bulkFileInput.addEventListener('change', this.handleBulkFileUpload.bind(this));
            }

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
            document.addEventListener('click', (e) => {
                // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
                const detailModal = document.getElementById('cert-detail-modal');
                if (detailModal && e.target === detailModal) {
                    this.closeCertDetailModal();
                }

                // ìˆ˜ì • ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
                const editModal = document.getElementById('cert-edit-modal');
                if (editModal && e.target === editModal) {
                    this.closeCertEditModal();
                }
            });

            // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸° (ìƒˆë¡œ ì¶”ê°€)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
                    this.closeCertDetailModal();
                    this.closeCertEditModal();
                    this.closeIssueCertModal();
                    this.closeBulkIssuanceModal();
                }
            });
        },

        /**
         * ìê²©ì¦ ìœ í˜• ì „í™˜
         */
        switchCertType: function (certType) {
            // ì´ë¯¸ ì„ íƒëœ ìœ í˜•ì´ë©´ ë¬´ì‹œ
            if (this.currentCertType === certType) return;

            // íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            const tabs = document.querySelectorAll('.cert-tab');
            tabs.forEach(tab => {
                if (tab.dataset.cert === certType) {
                    tab.classList.add('active', 'border-indigo-500', 'text-indigo-600');
                    tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                } else {
                    tab.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
            const certTypeTitle = document.getElementById('cert-type-title');
            if (certTypeTitle) {
                certTypeTitle.textContent = this.getCertTypeName(certType);
            }

            // í˜„ì¬ ìê²©ì¦ ìœ í˜• ì—…ë°ì´íŠ¸
            this.currentCertType = certType;
            this.currentPage = 1;
            this.lastDoc = null;

            // ìê²©ì¦ ë°ì´í„° ë¡œë“œ
            this.loadCertificates();
        },

        /**
         * ìê²©ì¦ ëª©ë¡ ë¡œë“œ
         */
        loadCertificates: async function () {
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                const tableBody = document.querySelector('#cert-table tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-gray-500">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                    </tr>
                `;

                // ìê²©ì¦ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                let certificates = [];

                // Firebaseê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected && window.dbService) {
                    try {
                        console.log('Firebaseì—ì„œ ìê²©ì¦ ë°ì´í„° ë¡œë“œ ì‹œì‘');

                        // í•„í„° ì˜µì…˜ ì„¤ì • - ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¨ìˆœí™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
                        let query = window.dhcFirebase.db.collection('certificates')
                            .where('certificateType', '==', this.currentCertType);

                        // ìƒíƒœ í•„í„° ì ìš© (ì„ íƒì )
                        const statusFilter = document.getElementById('filter-status')?.value;
                        if (statusFilter) {
                            query = query.where('status', '==', statusFilter);
                        }

                        // ê²€ìƒ‰ì–´ í•„í„°
                        const nameSearch = document.getElementById('search-name')?.value.trim();
                        const certNumberSearch = document.getElementById('search-cert-number')?.value.trim();

                        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¿¼ë¦¬ ì‹¤í–‰
                        if (!nameSearch && !certNumberSearch) {
                            const snapshot = await query.get();

                            if (!snapshot.empty) {
                                snapshot.forEach(doc => {
                                    certificates.push({
                                        id: doc.id,
                                        ...doc.data()
                                    });
                                });

                                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì •ë ¬ (ìµœì‹  ë°œê¸‰ì¼ ê¸°ì¤€)
                                certificates.sort((a, b) => {
                                    const dateA = a.issueDate?.seconds || 0;
                                    const dateB = b.issueDate?.seconds || 0;
                                    return dateB - dateA;
                                });

                                // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
                                const startIndex = (this.currentPage - 1) * this.pageSize;
                                certificates = certificates.slice(startIndex, startIndex + this.pageSize);
                            }
                        } else {
                            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§
                            const snapshot = await window.dhcFirebase.db.collection('certificates')
                                .where('certificateType', '==', this.currentCertType)
                                .get();

                            if (!snapshot.empty) {
                                const allCerts = [];
                                snapshot.forEach(doc => {
                                    allCerts.push({
                                        id: doc.id,
                                        ...doc.data()
                                    });
                                });

                                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í•„í„°ë§
                                certificates = allCerts.filter(cert => {
                                    // ìƒíƒœ í•„í„°
                                    if (statusFilter && cert.status !== statusFilter) {
                                        return false;
                                    }

                                    // ì´ë¦„ ê²€ìƒ‰
                                    if (nameSearch &&
                                        !(cert.holderName && cert.holderName.includes(nameSearch))) {
                                        return false;
                                    }

                                    // ìê²©ì¦ ë²ˆí˜¸ ê²€ìƒ‰
                                    if (certNumberSearch &&
                                        !(cert.certificateNumber && cert.certificateNumber.includes(certNumberSearch))) {
                                        return false;
                                    }

                                    return true;
                                });

                                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì •ë ¬ (ìµœì‹  ë°œê¸‰ì¼ ê¸°ì¤€)
                                certificates.sort((a, b) => {
                                    const dateA = a.issueDate?.seconds || 0;
                                    const dateB = b.issueDate?.seconds || 0;
                                    return dateB - dateA;
                                });

                                // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
                                const startIndex = (this.currentPage - 1) * this.pageSize;
                                certificates = certificates.slice(startIndex, startIndex + this.pageSize);
                            }
                        }
                    } catch (error) {
                        console.error('Firebase ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } else {
                    // Firebase ì—°ë™ ì „ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©
                    console.log('Firebase ë¯¸ì—°ê²°, í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©');
                    certificates = await this.getMockCertificates();
                }

                // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                this.updateCertificateTable(certificates);

                // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
                // ê¸°ì¡´ í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ì„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ìœ¼ë¡œ ë³€ê²½
                let totalCount = 0;

                if (firebaseStatus.connected && window.dhcFirebase && window.dhcFirebase.db) {
                    try {
                        // ì „ì²´ ê°œìˆ˜ë§Œ ê³„ì‚° (ì¸ë±ìŠ¤ ë¬¸ì œ ì—†ëŠ” ê°„ë‹¨í•œ ì¿¼ë¦¬)
                        const snapshot = await window.dhcFirebase.db.collection('certificates')
                            .where('certificateType', '==', this.currentCertType)
                            .get();

                        totalCount = snapshot.size;

                        // í•„í„°ë§ëœ ê²½ìš°ëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ê³„ì‚°
                        const statusFilter = document.getElementById('filter-status')?.value;
                        const nameSearch = document.getElementById('search-name')?.value.trim();
                        const certNumberSearch = document.getElementById('search-cert-number')?.value.trim();

                        if (statusFilter || nameSearch || certNumberSearch) {
                            // ë§¤ìš° ë§ì€ ë°ì´í„°ì¼ ê²½ìš° ì—¬ê¸°ì„œ ìµœì í™”ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
                            // í˜„ì¬ëŠ” ë‹¨ìˆœí•˜ê²Œ ë©”ëª¨ë¦¬ì—ì„œ í•„í„°ë§
                            totalCount = snapshot.docs.filter(doc => {
                                const data = doc.data();

                                // ìƒíƒœ í•„í„°
                                if (statusFilter && data.status !== statusFilter) {
                                    return false;
                                }

                                // ì´ë¦„ ê²€ìƒ‰
                                if (nameSearch &&
                                    !(data.holderName && data.holderName.includes(nameSearch))) {
                                    return false;
                                }

                                // ìê²©ì¦ ë²ˆí˜¸ ê²€ìƒ‰
                                if (certNumberSearch &&
                                    !(data.certificateNumber && data.certificateNumber.includes(certNumberSearch))) {
                                    return false;
                                }

                                return true;
                            }).length;
                        }
                    } catch (error) {
                        console.error('ë¬¸ì„œ ìˆ˜ ê³„ì‚° ì˜¤ë¥˜:', error);
                        totalCount = certificates.length > 0 ? certificates.length + (this.currentPage - 1) * this.pageSize : 0;
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°ëŠ” 20ê°œë¡œ ê°€ì •
                    totalCount = 20;
                }

                const totalPages = Math.ceil(totalCount / this.pageSize);
                this.updatePagination(this.currentPage, totalPages);

            } catch (error) {
                console.error('ìê²©ì¦ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);

                const tableBody = document.querySelector('#cert-table tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-red-500">ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td>
                    </tr>
                `;
            }
        },

        /**
         * ìê²©ì¦ í…Œì´ë¸” ì—…ë°ì´íŠ¸ - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš© + PDF ì•„ì´ì½˜ ìˆ˜ì •
         */
        updateCertificateTable: function (certificates) {
            const tableBody = document.querySelector('#cert-table tbody');

            if (!certificates || certificates.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="admin-empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z">
                        </path>
                    </svg>
                    <h3>ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ìƒˆë¡œìš´ ìê²©ì¦ì„ ë°œê¸‰í•´ë³´ì„¸ìš”.</p>
                </td>
            </tr>
        `;
                return;
            }

            let tableHtml = '';

            certificates.forEach(cert => {
                // ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš© - formatDate
                const issueDate = cert.issueDate && typeof cert.issueDate.toDate === 'function'
                    ? window.formatters.formatDate(cert.issueDate.toDate(), 'YYYY-MM-DD')
                    : (cert.issueDate ? window.formatters.formatDate(cert.issueDate, 'YYYY-MM-DD') : '-');

                const expiryDate = cert.expiryDate && typeof cert.expiryDate.toDate === 'function'
                    ? window.formatters.formatDate(cert.expiryDate.toDate(), 'YYYY-MM-DD')
                    : (cert.expiryDate ? window.formatters.formatDate(cert.expiryDate, 'YYYY-MM-DD') : '-');

                const getStatusBadge = (status) => {
                    const badges = {
                        'active': '<span class="cert-status-badge status-valid">ìœ íš¨</span>',
                        'expired': '<span class="cert-status-badge status-expired">ë§Œë£Œ</span>',
                        'revoked': '<span class="cert-status-badge status-suspended">ì·¨ì†Œ</span>',
                        'suspended': '<span class="cert-status-badge status-suspended">ì •ì§€</span>'
                    };
                    return badges[status] || `<span class="cert-status-badge status-expired">${this.getStatusText(status)}</span>`;
                };

                // ğŸ¯ ë°˜ì‘í˜• í…Œì´ë¸”: data-label ì†ì„± ì¶”ê°€ + ğŸ”§ PDF ì•„ì´ì½˜ ìˆ˜ì •
                tableHtml += `
            <tr class="hover:bg-gray-50 transition-colors">
                <td data-label="ì„ íƒ" class="text-center">
                    <input type="checkbox" class="cert-checkbox" data-id="${cert.id}">
                </td>
                <td data-label="ìê²©ì¦ ë²ˆí˜¸">${cert.certificateNumber || cert.certNumber || '-'}</td>
                <td data-label="ìˆ˜ë£Œìëª…">${cert.holderName || cert.name || '-'}</td>
                <td data-label="êµìœ¡ ê³¼ì •">${cert.courseName || cert.course || '-'}</td>
                <td data-label="ë°œê¸‰ì¼">${issueDate}</td>
                <td data-label="ë§Œë£Œì¼">${expiryDate}</td>
                <td data-label="ìƒíƒœ">${getStatusBadge(cert.status)}</td>
                <td data-label="ì‘ì—…">
                    <div class="table-actions">
                        <button onclick="certManager.viewCertDetails('${cert.id}')" 
                            class="table-action-btn btn-view" title="ìƒì„¸ ë³´ê¸°">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                </path>
                            </svg>
                            ìƒì„¸
                        </button>
                        <button onclick="certManager.editCert('${cert.id}')" 
                            class="table-action-btn btn-edit" title="ìˆ˜ì •">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                            ìˆ˜ì •
                        </button>
                        
                        <!-- ğŸ”§ PDF ì•„ì´ì½˜ ìˆ˜ì •: ë‹¤ìš´ë¡œë“œ í™”ì‚´í‘œ â†’ PDF íŒŒì¼ ì•„ì´ì½˜ -->
                        <div class="cert-pdf-dropdown">
                            <button onclick="certManager.togglePdfDropdown('${cert.id}')" 
                                class="cert-pdf-btn" title="PDF ë‹¤ìš´ë¡œë“œ">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                PDF
                            </button>
                            <div id="pdf-dropdown-${cert.id}" class="cert-pdf-menu hidden">
                                <a href="#" onclick="certManager.downloadCertPdf('${cert.id}', 'ko'); event.preventDefault();">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    í•œê¸€ PDF
                                </a>
                                <a href="#" onclick="certManager.downloadCertPdf('${cert.id}', 'en'); event.preventDefault();">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    ì˜ë¬¸ PDF
                                </a>
                            </div>
                        </div>
                        
                        ${cert.status !== 'suspended' && cert.status !== 'revoked' ? `
                            <button onclick="certManager.revokeCertificate('${cert.id}')" 
                                class="table-action-btn btn-delete" title="ìê²©ì¦ ì·¨ì†Œ">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                ì·¨ì†Œ
                                </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
            });

            tableBody.innerHTML = tableHtml;

            // ğŸ”§ ê°œì„ ëœ PDF ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì²˜ë¦¬
            this.initPdfDropdowns();
        },

        /**
         * PDF ë“œë¡­ë‹¤ìš´ í† ê¸€ (ìƒˆë¡œ ì¶”ê°€)
         */
        togglePdfDropdown: function (certId) {
            const dropdown = document.getElementById(`pdf-dropdown-${certId}`);
            if (!dropdown) return;

            // ë‹¤ë¥¸ ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('[id^="pdf-dropdown-"]').forEach(dd => {
                if (dd.id !== `pdf-dropdown-${certId}`) {
                    dd.classList.add('hidden');
                    dd.classList.remove('show');
                }
            });

            // í˜„ì¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
            dropdown.classList.toggle('hidden');
            dropdown.classList.toggle('show');
        },

        /**
         * ğŸ”§ PDF ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” (z-index ë¬¸ì œ í•´ê²°)
         */
        initPdfDropdowns: function () {
            // ğŸ”§ ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° ë°©ì§€
            if (this._pdfDropdownInitialized) return;
            this._pdfDropdownInitialized = true;

            // ì „ì—­ í´ë¦­ ì´ë²¤íŠ¸ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                // PDF ë²„íŠ¼ì´ë‚˜ ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ë‹«ê¸°
                if (!e.target.closest('.cert-pdf-dropdown')) {
                    document.querySelectorAll('[id^="pdf-dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                        dropdown.classList.remove('show');
                    });
                }
            });

            // ESC í‚¤ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('[id^="pdf-dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                        dropdown.classList.remove('show');
                    });
                }
            });

            console.log('âœ… PDF ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ì™„ë£Œ');
        },

        /**
         * PDF ì˜µì…˜ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
         */
        showPdfOptions: function (certId) {
            // ì´ë²¤íŠ¸ëŠ” updateCertificateTableì—ì„œ ì²˜ë¦¬ë¨
        },

        /**
         * í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
         */
        updatePagination: function (currentPage, totalPages) {
            const paginationContainer = document.getElementById('cert-pagination');

            if (!paginationContainer) return;

            let paginationHtml = '<div class="flex justify-center">';

            // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
            paginationHtml += `
                <button onclick="certManager.changePage(${currentPage - 1})" 
                    class="px-3 py-1 rounded-md mx-1 ${currentPage <= 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-gray-100 text-gray-700'}"
                    ${currentPage <= 1 ? 'disabled' : ''}>
                    ì´ì „
                </button>
            `;

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button onclick="certManager.changePage(${i})" 
                        class="px-3 py-1 rounded-md mx-1 ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-white hover:bg-gray-100 text-gray-700'}">
                        ${i}
                    </button>
                `;
            }

            // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
            paginationHtml += `
                <button onclick="certManager.changePage(${currentPage + 1})" 
                    class="px-3 py-1 rounded-md mx-1 ${currentPage >= totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-gray-100 text-gray-700'}"
                    ${currentPage >= totalPages ? 'disabled' : ''}>
                    ë‹¤ìŒ
                </button>
            `;

            paginationHtml += '</div>';

            paginationContainer.innerHTML = paginationHtml;
        },

        /**
         * í˜ì´ì§€ ë³€ê²½
         */
        changePage: function (page) {
            // ìœ íš¨í•œ í˜ì´ì§€ ì²´í¬
            if (page < 1) return;

            this.currentPage = page;
            this.loadCertificates();
        },

        /**
         * ê²€ìƒ‰ ê¸°ëŠ¥
         */
        search: function () {
            // ê²€ìƒ‰ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
            this.currentPage = 1;
            this.lastDoc = null;
            this.loadCertificates();
        },

        /**
         * ê²€ìƒ‰ í•„í„° ì´ˆê¸°í™”
         */
        resetFilters: function () {
            console.log('ê²€ìƒ‰ í•„í„° ì´ˆê¸°í™”');

            // ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
            const searchName = document.getElementById('search-name');
            if (searchName) searchName.value = '';

            const searchCertNumber = document.getElementById('search-cert-number');
            if (searchCertNumber) searchCertNumber.value = '';

            const statusFilter = document.getElementById('filter-status');
            if (statusFilter) statusFilter.value = '';

            // í˜ì´ì§€ ìƒíƒœ ì´ˆê¸°í™”
            this.currentPage = 1;
            this.lastDoc = null;

            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            this.loadCertificates();

            // ì‚¬ìš©ì í”¼ë“œë°±
            if (window.adminAuth && window.adminAuth.showNotification) {
                window.adminAuth.showNotification('ê²€ìƒ‰ í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        },

        /**
         * ìê²©ì¦ ë°œê¸‰ ëª¨ë‹¬ í‘œì‹œ
         */
        showIssueCertModal: function () {
            const modal = document.getElementById('cert-issue-modal');
            if (modal) {
                modal.classList.remove('hidden');

                // êµìœ¡ ê³¼ì • ì˜µì…˜ ë¡œë“œ
                this.loadCourseOptions();

                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë°œê¸‰ì¼ ì„¤ì • - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                const issueDateInput = document.getElementById('issue-completion-date');
                if (issueDateInput) {
                    const today = new Date();
                    issueDateInput.value = window.formatters.formatDate(today, 'YYYY-MM-DD');
                }

                // 3ë…„ í›„ ë‚ ì§œë¡œ ë§Œë£Œì¼ ì„¤ì • - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                const expiryDateInput = document.getElementById('issue-expiry-date');
                if (expiryDateInput) {
                    const expiryDate = window.dateUtils.addYears(new Date(), 3);
                    expiryDateInput.value = window.formatters.formatDate(expiryDate, 'YYYY-MM-DD');
                }
            }
        },

        /**
         * ìê²©ì¦ ë°œê¸‰ ëª¨ë‹¬ ë‹«ê¸°
         */
        closeIssueCertModal: function () {
            const modal = document.getElementById('cert-issue-modal');
            if (modal) {
                modal.classList.add('hidden');

                // í¼ ì´ˆê¸°í™”
                const form = document.getElementById('cert-issue-form');
                if (form) form.reset();
            }
        },

        /**
         * ì¼ê´„ ë°œê¸‰ ëª¨ë‹¬ í‘œì‹œ
         */
        showBulkIssuanceModal: function () {
            const modal = document.getElementById('bulk-issue-modal');
            if (modal) {
                modal.classList.remove('hidden');

                // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì´ˆê¸°í™”
                const previewArea = document.getElementById('bulk-preview');
                if (previewArea) previewArea.classList.add('hidden');

                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                const fileInput = document.getElementById('bulk-file');
                if (fileInput) fileInput.value = '';

                // ë²„íŠ¼ ë¹„í™œì„±í™”
                const bulkIssueBtn = document.getElementById('bulk-issue-btn');
                if (bulkIssueBtn) bulkIssueBtn.disabled = true;
            }
        },

        /**
         * ì¼ê´„ ë°œê¸‰ ëª¨ë‹¬ ë‹«ê¸°
         */
        closeBulkIssuanceModal: function () {
            const modal = document.getElementById('bulk-issue-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        },

        /**
         * ì¼ê´„ ë°œê¸‰ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
         */
        handleBulkFileUpload: function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const previewArea = document.getElementById('bulk-preview');
            const previewHeader = document.getElementById('bulk-preview-header');
            const previewBody = document.getElementById('bulk-preview-body');
            const bulkIssueBtn = document.getElementById('bulk-issue-btn');

            // íŒŒì¼ í˜•ì‹ í™•ì¸ (xlsx, xlsë§Œ í—ˆìš©)
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                window.adminAuth?.showNotification('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                event.target.value = '';
                return;
            }

            // ì—¬ê¸°ì„œëŠ” ì‹¤ì œ íŒŒì¼ ì²˜ë¦¬ëŠ” ìƒëµí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë§Œ í‘œì‹œ
            previewHeader.innerHTML = `
                <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-4 py-2">ì´ë¦„</th>
                    <th class="border border-gray-300 px-4 py-2">ì´ë©”ì¼</th>
                    <th class="border border-gray-300 px-4 py-2">êµìœ¡ê³¼ì •</th>
                    <th class="border border-gray-300 px-4 py-2">ìˆ˜ë£Œì¼</th>
                </tr>
            `;

            // ìƒ˜í”Œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            previewBody.innerHTML = `
                <tr>
                    <td class="border border-gray-300 px-4 py-2">í™ê¸¸ë™</td>
                    <td class="border border-gray-300 px-4 py-2">hong@example.com</td>
                    <td class="border border-gray-300 px-4 py-2">ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 1ê¸°</td>
                    <td class="border border-gray-300 px-4 py-2">2025-03-15</td>
                </tr>
                <tr>
                    <td class="border border-gray-300 px-4 py-2">ê¹€ì² ìˆ˜</td>
                    <td class="border border-gray-300 px-4 py-2">kim@example.com</td>
                    <td class="border border-gray-300 px-4 py-2">ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 1ê¸°</td>
                    <td class="border border-gray-300 px-4 py-2">2025-03-15</td>
                </tr>
            `;

            previewArea.classList.remove('hidden');

            // ì¼ê´„ ë°œê¸‰ ë²„íŠ¼ í™œì„±í™”
            if (bulkIssueBtn) bulkIssueBtn.disabled = false;
        },

        /**
         * ì¼ê´„ ë°œê¸‰ ì²˜ë¦¬
         */
        processBulkIssuance: function () {
            const fileInput = document.getElementById('bulk-file');
            if (!fileInput || !fileInput.files[0]) {
                window.adminAuth?.showNotification('ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            if (window.adminUtils?.showLoadingOverlay) {
                window.adminUtils.showLoadingOverlay(true);
            }

            // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ íŒŒì¼ ì²˜ë¦¬ ë° DB ì €ì¥ ë¡œì§ êµ¬í˜„
            setTimeout(() => {
                // ë¡œë”© ì¢…ë£Œ
                if (window.adminUtils?.showLoadingOverlay) {
                    window.adminUtils.showLoadingOverlay(false);
                }

                // ëª¨ë‹¬ ë‹«ê¸°
                this.closeBulkIssuanceModal();

                // ì„±ê³µ ë©”ì‹œì§€
                window.adminAuth?.showNotification('ìê²©ì¦ ì¼ê´„ ë°œê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                this.loadCertificates();
            }, 2000);
        },

        /**
         * êµìœ¡ ê³¼ì • ì˜µì…˜ ë¡œë“œ
         */
        loadCourseOptions: async function () {
            const courseSelect = document.getElementById('issue-course');

            if (!courseSelect) return;

            courseSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

            try {
                let courses = [];

                // Firebase ì—°ë™ ì‹œ
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected && window.dbService) {
                    try {
                        console.log('Firebaseì—ì„œ êµìœ¡ ê³¼ì • ë¡œë“œ ì‹œì‘');

                        // í˜„ì¬ ìê²©ì¦ ìœ í˜•ì— ë§ëŠ” êµìœ¡ ê³¼ì •ë§Œ ì¡°íšŒ - ë‹¨ìˆœ ì¿¼ë¦¬ë¡œ ìˆ˜ì •
                        const query = window.dhcFirebase.db.collection('courses')
                            .where('certificateType', '==', this.currentCertType);

                        const snapshot = await query.get();

                        if (!snapshot.empty) {
                            snapshot.forEach(doc => {
                                courses.push({
                                    id: doc.id,
                                    ...doc.data()
                                });
                            });

                            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì¶”ê°€ í•„í„°ë§ ë° ì •ë ¬
                            courses = courses.filter(course =>
                                course.status === 'completed' || course.status === 'closed'
                            );

                            // ìµœì‹  ì¢…ë£Œì¼ ê¸°ì¤€ ì •ë ¬
                            courses.sort((a, b) => {
                                const dateA = a.endDate?.seconds || 0;
                                const dateB = b.endDate?.seconds || 0;
                                return dateB - dateA;
                            });
                        }
                    } catch (error) {
                        console.error('êµìœ¡ ê³¼ì • ì¿¼ë¦¬ ì˜¤ë¥˜:', error);
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ ì‚¬ìš©
                        courses = [];
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                    courses = [
                        {
                            id: 'course1',
                            title: '2025ë…„ 1ê¸° ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ ê³¼ì •',
                            startDate: '2025-01-15',
                            endDate: '2025-03-15'
                        },
                        {
                            id: 'course2',
                            title: '2024ë…„ 4ê¸° ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ ê³¼ì •',
                            startDate: '2024-10-01',
                            endDate: '2024-12-15'
                        }
                    ];
                }

                // ì˜µì…˜ ì—…ë°ì´íŠ¸
                if (courses.length > 0) {
                    courseSelect.innerHTML = '<option value="">êµìœ¡ ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>';

                    courses.forEach(course => {
                        // ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                        const startDate = typeof course.startDate === 'string' ? course.startDate :
                            (course.startDate?.toDate ? window.formatters.formatDate(course.startDate.toDate(), 'YYYY-MM-DD') : '-');

                        const endDate = typeof course.endDate === 'string' ? course.endDate :
                            (course.endDate?.toDate ? window.formatters.formatDate(course.endDate.toDate(), 'YYYY-MM-DD') : '-');

                        courseSelect.innerHTML += `
                            <option value="${course.id}">${course.title} (${startDate} ~ ${endDate})</option>
                        `;
                    });
                } else {
                    courseSelect.innerHTML = '<option value="">êµìœ¡ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</option>';
                }
            } catch (error) {
                console.error('êµìœ¡ ê³¼ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                courseSelect.innerHTML = '<option value="">êµìœ¡ ê³¼ì • ë¡œë“œ ì‹¤íŒ¨</option>';
            }
        },

        /**
         * ìê²©ì¦ ë°œê¸‰ ì²˜ë¦¬
         */
        issueCertificate: async function (form) {
            try {
                // í¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const name = document.getElementById('issue-name').value.trim();
                const email = document.getElementById('issue-email').value.trim();
                const courseId = document.getElementById('issue-course').value;
                const completionDate = document.getElementById('issue-completion-date').value;
                const expiryDate = document.getElementById('issue-expiry-date').value;

                // ìœ íš¨ì„± ê²€ì‚¬
                if (!name || !email || !courseId || !completionDate || !expiryDate) {
                    window.adminAuth?.showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ë¡œë”© í‘œì‹œ
                if (window.adminUtils?.showLoadingOverlay) {
                    window.adminUtils.showLoadingOverlay(true);
                }

                // ìê²©ì¦ ë²ˆí˜¸ ìƒì„± (ì˜ˆ: HE-2025-0001)
                const certTypePrefix = {
                    'health-exercise': 'HE',
                    'rehabilitation': 'RE',
                    'pilates': 'PI',
                    'recreation': 'RC'
                }[this.currentCertType] || 'XX';

                const year = new Date().getFullYear();
                const count = await this.getCertificateCount(this.currentCertType, year);
                const certificateNumber = `${certTypePrefix}-${year}-${String(count + 1).padStart(4, '0')}`;

                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    // ìê²©ì¦ ë°ì´í„° ìƒì„±
                    const certData = {
                        certificateNumber: certificateNumber,
                        certificateType: this.currentCertType,
                        holderName: name,
                        holderEmail: email,
                        courseId: courseId,
                        issueDate: window.dhcFirebase.firebase.firestore.Timestamp.fromDate(new Date(completionDate)),
                        expiryDate: window.dhcFirebase.firebase.firestore.Timestamp.fromDate(new Date(expiryDate)),
                        status: 'active',
                        createdAt: window.dhcFirebase.firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: window.dhcFirebase.firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Firebaseì— ì €ì¥
                    try {
                        const docRef = await window.dhcFirebase.db.collection('certificates').add(certData);

                        // ì„±ê³µ
                        window.adminAuth?.showNotification('ìê²©ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª¨ë‹¬ ë‹«ê¸°
                        this.closeIssueCertModal();

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    } catch (error) {
                        console.error('ìê²©ì¦ ì €ì¥ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                    setTimeout(() => {
                        // ì„±ê³µ ë©”ì‹œì§€
                        window.adminAuth?.showNotification('ìê²©ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª¨ë‹¬ ë‹«ê¸°
                        this.closeIssueCertModal();

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    }, 1000);
                }
            } catch (error) {
                console.error('ìê²©ì¦ ë°œê¸‰ ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('ìê²©ì¦ ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ë¡œë”© ì¢…ë£Œ
                if (window.adminUtils?.showLoadingOverlay) {
                    window.adminUtils.showLoadingOverlay(false);
                }
            }
        },

        /**
         * ìê²©ì¦ ìˆ˜ ì¡°íšŒ (ë²ˆí˜¸ ìƒì„±ìš©)
         */
        getCertificateCount: async function (certType, year) {
            try {
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    const startOfYear = new Date(year, 0, 1);
                    const endOfYear = new Date(year + 1, 0, 1);

                    // ë‹¨ìˆœ ì¿¼ë¦¬ë¡œ ë³€ê²½ (ì¸ë±ìŠ¤ ë¬¸ì œ í•´ê²°)
                    const query = window.dhcFirebase.db.collection('certificates')
                        .where('certificateType', '==', certType);

                    const snapshot = await query.get();

                    // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í•„í„°ë§ (ì—°ë„ë³„)
                    let count = 0;

                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const issueDate = data.issueDate?.toDate ? data.issueDate.toDate() : null;

                            if (issueDate && issueDate >= startOfYear && issueDate < endOfYear) {
                                count++;
                            }
                        });
                    }

                    return count;
                }

                // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” 0 ë°˜í™˜ (ì²« ë²ˆì§¸ ìê²©ì¦ ë²ˆí˜¸ëŠ” 0001ì´ ë¨)
                return 0;
            } catch (error) {
                console.error('ìê²©ì¦ ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return 0;
            }
        },

        /**
         * ì „ì²´ ì„ íƒ í† ê¸€
         */
        toggleSelectAll: function (checkbox) {
            const certCheckboxes = document.querySelectorAll('.cert-checkbox');
            certCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        },

        /**
         * ìê²©ì¦ ìƒì„¸ ì •ë³´ ë³´ê¸°
         */
        viewCertDetails: async function (certId) {
            try {
                // ë¡œë”© í‘œì‹œ
                if (window.adminAuth?.showNotification) {
                    window.adminAuth.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                }

                let cert = null;
                let courseName = '-';
                let userName = '-';
                let userEmail = '-';

                // Firebase ì—°ë™ ì‹œ
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    // ìê²©ì¦ ì •ë³´ ì¡°íšŒ
                    try {
                        const docRef = window.dhcFirebase.db.collection('certificates').doc(certId);
                        const docSnap = await docRef.get();

                        if (docSnap.exists) {
                            cert = {
                                id: docSnap.id,
                                ...docSnap.data()
                            };

                            // êµìœ¡ ê³¼ì • ì •ë³´ ì¡°íšŒ (ì„ íƒì )
                            if (cert.courseId) {
                                try {
                                    const courseRef = window.dhcFirebase.db.collection('courses').doc(cert.courseId);
                                    const courseSnap = await courseRef.get();

                                    if (courseSnap.exists) {
                                        courseName = courseSnap.data().title || '-';
                                    }
                                } catch (error) {
                                    console.error('êµìœ¡ ê³¼ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
                                }
                            }

                            // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì„ íƒì )
                            if (cert.userId) {
                                try {
                                    const userRef = window.dhcFirebase.db.collection('users').doc(cert.userId);
                                    const userSnap = await userRef.get();

                                    if (userSnap.exists) {
                                        userName = userSnap.data().displayName || '-';
                                        userEmail = userSnap.data().email || '-';
                                    }
                                } catch (error) {
                                    console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                                }
                            }
                        } else {
                            window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('ìê²©ì¦ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                    cert = this.getMockCertificateById(certId);
                    if (!cert) {
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    courseName = cert.course || '-';
                    userName = cert.name || '-';
                    userEmail = 'user@example.com';
                }

                // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
                const modalContent = document.getElementById('cert-detail-content');
                modalContent.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium text-gray-700">ìê²©ì¦ ë²ˆí˜¸</h4>
                    <p class="text-gray-900">${cert.certificateNumber || cert.certNumber || '-'}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">ìê²©ì¦ ì¢…ë¥˜</h4>
                    <p class="text-gray-900">${this.getCertTypeName(cert.certificateType || this.currentCertType)}</p>
                </div>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-700">ìˆ˜ë£Œì ì •ë³´</h4>
                <p class="text-gray-900">${cert.holderName || userName} (${cert.holderEmail || userEmail})</p>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-700">êµìœ¡ ê³¼ì •</h4>
                <p class="text-gray-900">${courseName}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium text-gray-700">ë°œê¸‰ì¼</h4>
                    <p class="text-gray-900">${this.formatDate(cert.issueDate) || cert.issueDate || '-'}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">ë§Œë£Œì¼</h4>
                    <p class="text-gray-900">${this.formatDate(cert.expiryDate) || cert.expiryDate || '-'}</p>
                </div>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-700">ìƒíƒœ</h4>
                <p>
                    <span class="px-2 py-1 rounded-full text-xs 
                        ${cert.status === 'active' ? 'bg-green-100 text-green-800' :
                        cert.status === 'expired' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'}">
                        ${this.getStatusText(cert.status)}
                    </span>
                </p>
            </div>
            
            <div>
                <h4 class="font-medium text-gray-700">ë¹„ê³ </h4>
                <p class="text-gray-900 whitespace-pre-wrap">${cert.remarks || '-'}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium text-gray-700">ë“±ë¡ì¼ì‹œ</h4>
                    <p class="text-gray-900">${this.formatDate(cert.createdAt, true) || '-'}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">ìˆ˜ì •ì¼ì‹œ</h4>
                    <p class="text-gray-900">${this.formatDate(cert.updatedAt, true) || '-'}</p>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="font-medium text-gray-700">ìê²©ì¦ PDF ë‹¤ìš´ë¡œë“œ</h4>
                <div class="flex space-x-3 mt-2">
                    <button onclick="certManager.downloadCertPdf('${certId}', 'ko'); certManager.closeCertDetailModal();" 
                        class="admin-btn admin-btn-secondary">
                        í•œê¸€ PDF
                    </button>
                    <button onclick="certManager.downloadCertPdf('${certId}', 'en'); certManager.closeCertDetailModal();" 
                        class="admin-btn admin-btn-primary">
                        ì˜ë¬¸ PDF
                    </button>
                </div>
            </div>
        `;

                // ëª¨ë‹¬ í‘œì‹œ
                const modal = document.getElementById('cert-detail-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                }

            } catch (error) {
                console.error('ìê²©ì¦ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },

        /**
         * ìê²©ì¦ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
         */
        closeCertDetailModal: function () {
            const modal = document.getElementById('cert-detail-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        },

        /**
         * ìê²©ì¦ ìˆ˜ì •
         */
        editCert: async function (certId) {
            try {
                // ë¡œë”© í‘œì‹œ
                if (window.adminAuth?.showNotification) {
                    window.adminAuth.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                }

                let cert = null;

                // Firebase ì—°ë™ ì‹œ
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    // ìê²©ì¦ ì •ë³´ ì¡°íšŒ
                    try {
                        const docRef = window.dhcFirebase.db.collection('certificates').doc(certId);
                        const docSnap = await docRef.get();

                        if (docSnap.exists) {
                            cert = {
                                id: docSnap.id,
                                ...docSnap.data()
                            };
                        } else {
                            window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('ìê²©ì¦ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                    cert = this.getMockCertificateById(certId);
                    if (!cert) {
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                }

                // í¼ì— ë°ì´í„° ì…ë ¥
                document.getElementById('edit-cert-id').value = certId;
                document.getElementById('edit-cert-number').value = cert.certificateNumber || cert.certNumber || '';
                document.getElementById('edit-holder-name').value = cert.holderName || cert.name || '';
                document.getElementById('edit-issue-date').value = this.formatDateToInput(cert.issueDate) || cert.issueDate || '';
                document.getElementById('edit-expiry-date').value = this.formatDateToInput(cert.expiryDate) || cert.expiryDate || '';
                document.getElementById('edit-status').value = cert.status || 'active';
                document.getElementById('edit-remarks').value = cert.remarks || '';

                // ëª¨ë‹¬ í‘œì‹œ
                const modal = document.getElementById('cert-edit-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                }

            } catch (error) {
                console.error('ìê²©ì¦ ìˆ˜ì • í¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },

        /**
         * ìê²©ì¦ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
         */
        closeCertEditModal: function () {
            const modal = document.getElementById('cert-edit-modal');
            if (modal) {
                modal.classList.add('hidden');

                // í¼ ì´ˆê¸°í™”
                const form = document.getElementById('cert-edit-form');
                if (form) form.reset();
            }
        },

        /**
         * ìê²©ì¦ ìˆ˜ì • ì²˜ë¦¬
         */
        handleUpdateCertificate: async function (event) {
            event.preventDefault();

            try {
                // ë¡œë”© í‘œì‹œ
                if (window.adminAuth?.showNotification) {
                    window.adminAuth.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ì¤‘...', 'info');
                }

                // í¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const certId = document.getElementById('edit-cert-id').value;
                const issueDate = document.getElementById('edit-issue-date').value;
                const expiryDate = document.getElementById('edit-expiry-date').value;
                const status = document.getElementById('edit-status').value;
                const remarks = document.getElementById('edit-remarks').value;

                // ìœ íš¨ì„± ê²€ì‚¬
                if (!issueDate || !expiryDate || !status) {
                    window.adminAuth?.showNotification('í•„ìˆ˜ í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // Firebase ì—°ë™ ì‹œ
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    // ì—…ë°ì´íŠ¸ ë°ì´í„°
                    const updateData = {
                        issueDate: window.dhcFirebase.firebase.firestore.Timestamp.fromDate(new Date(issueDate)),
                        expiryDate: window.dhcFirebase.firebase.firestore.Timestamp.fromDate(new Date(expiryDate)),
                        status: status,
                        remarks: remarks,
                        updatedAt: window.dhcFirebase.firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Firebaseì— ì—…ë°ì´íŠ¸
                    try {
                        const docRef = window.dhcFirebase.db.collection('certificates').doc(certId);
                        await docRef.update(updateData);

                        // ëª¨ë‹¬ ë‹«ê¸°
                        this.closeCertEditModal();

                        // ì„±ê³µ ë©”ì‹œì§€
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    } catch (error) {
                        console.error('ìê²©ì¦ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                    setTimeout(() => {
                        // ëª¨ë‹¬ ë‹«ê¸°
                        this.closeCertEditModal();

                        // ì„±ê³µ ë©”ì‹œì§€
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    }, 1000);
                }
            } catch (error) {
                console.error('ìê²©ì¦ ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },

        /**
         * ìê²©ì¦ PDF ë‹¤ìš´ë¡œë“œ
         */
        downloadCertPdf: function (certId, lang) {
            window.adminAuth?.showNotification('PDF ìƒì„± ì¤‘...', 'info');

            // ì–¸ì–´ì— ë”°ë¥¸ í•¨ìˆ˜ í˜¸ì¶œ
            if (window.jspdf) {
                if (lang === 'ko') {
                    this.generateKoreanCertPdf(certId);
                } else {
                    this.generateEnglishCertPdf(certId);
                }
            } else {
                // jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ìš”ì²­
                this.loadJsPdfLibrary(() => {
                    if (lang === 'ko') {
                        this.generateKoreanCertPdf(certId);
                    } else {
                        this.generateEnglishCertPdf(certId);
                    }
                });
            }
        },

        /**
         * jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
         */
        loadJsPdfLibrary: function (callback) {
            // jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ ë™ì ìœ¼ë¡œ ë¡œë“œ
            if (!window.jspdf) {
                const jsPdfScript = document.createElement('script');
                jsPdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                jsPdfScript.onload = () => {
                    // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (í•œê¸€ ì§€ì›ìš©)
                    const html2canvasScript = document.createElement('script');
                    html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    html2canvasScript.onload = callback;
                    document.head.appendChild(html2canvasScript);
                };
                document.head.appendChild(jsPdfScript);
            } else {
                // ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ì½œë°± ì‹¤í–‰
                callback();
            }
        },

        /**
         * í…Œë‘ë¦¬ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ìœ„í•œ CSS í…Œë‘ë¦¬ ìƒì„± í•¨ìˆ˜
         */
        createBorderCSS: function () {
            // í…Œë‘ë¦¬ ìš”ì†Œì— ì ìš©í•  CSS ìŠ¤íƒ€ì¼
            return `
            .certificate-border {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border: 1px solid #f0c040;
                margin: 40px;
                pointer-events: none;
                z-index: 5;
            }
            
            .certificate-border::before,
            .certificate-border::after,
            .certificate-border-inner::before,
            .certificate-border-inner::after {
                content: '';
                position: absolute;
                width: 80px;
                height: 80px;
                background-color: transparent;
                border: 3px solid #f0c040;
                z-index: 5;
            }
            
            /* ì¢Œìƒë‹¨ ëª¨ì„œë¦¬ */
            .certificate-border::before {
                top: -3px;
                left: -3px;
                border-right: none;
                border-bottom: none;
            }
            
            /* ìš°ìƒë‹¨ ëª¨ì„œë¦¬ */
            .certificate-border::after {
                top: -3px;
                right: -3px;
                border-left: none;
                border-bottom: none;
            }
            
            /* ì¢Œí•˜ë‹¨ ëª¨ì„œë¦¬ */
            .certificate-border-inner::before {
                bottom: -3px;
                left: -3px;
                border-right: none;
                border-top: none;
            }
            
            /* ìš°í•˜ë‹¨ ëª¨ì„œë¦¬ */
            .certificate-border-inner::after {
                bottom: -3px;
                right: -3px;
                border-left: none;
                border-top: none;
            }
            
            /* ì¥ì‹ì ì¸ ê³¡ì„  ìš”ì†Œ */
            .certificate-border-decoration {
                position: absolute;
                width: 100%;
                pointer-events: none;
                z-index: 5;
            }
            
            .decoration-top {
                top: 5px;
                height: 20px;
                background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0wLDEwIEMxMDAsNDAgMTUwLC0xMCAyNTAsMTAgQzM1MCw0MCA0MDAsLTEwIDUwMCwxMCIgc3Ryb2tlPSIjZjBjMDQwIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjEuNSIvPjwvc3ZnPg==') repeat-x center;
            }
            
            .decoration-bottom {
                bottom: 5px;
                height: 20px;
                background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0wLDEwIEMxMDAsLTIwIDE1MCw0MCAyNTAsMTAgQzM1MCwtMjAgNDAwLDQwIDUwMCwxMCIgc3Ryb2tlPSIjZjBjMDQwIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjEuNSIvPjwvc3ZnPg==') repeat-x center;
            }
            
            .decoration-left {
                left: 5px;
                width: 20px;
                height: 100%;
                background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iNTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMCwwIEMtMjAsMTAwIDQwLDE1MCAxMCwyNTAgQy0yMCwzNTAgNDAsNDAwIDEwLDUwMCIgc3Ryb2tlPSIjZjBjMDQwIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjEuNSIvPjwvc3ZnPg==') repeat-y center;
            }
            
            .decoration-right {
                right: 5px;
                width: 20px;
                height: 100%;
                background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iNTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMCwwIEMzMCwxMDAgLTIwLDE1MCAxMCwyNTAgQzMwLDM1MCAtMjAsNDAwIDEwLDUwMCIgc3Ryb2tlPSIjZjBjMDQwIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjEuNSIvPjwvc3ZnPg==') repeat-y center;
            }
        `;
        },

        /**
         * CSSì™€ HTMLì„ ì‚¬ìš©í•œ í…Œë‘ë¦¬ ìƒì„± í•¨ìˆ˜
         */
        createCSSDerivedBorder: function (container) {
            // ìŠ¤íƒ€ì¼ íƒœê·¸ ì¶”ê°€
            const styleTag = document.createElement('style');
            styleTag.textContent = this.createBorderCSS();
            document.head.appendChild(styleTag);

            // í…Œë‘ë¦¬ ì»¨í…Œì´ë„ˆ ìƒì„±
            const borderContainer = document.createElement('div');
            borderContainer.className = 'certificate-border';

            // ë‚´ë¶€ í…Œë‘ë¦¬ ìš”ì†Œ (for ì¢Œí•˜ë‹¨, ìš°í•˜ë‹¨ ëª¨ì„œë¦¬)
            const borderInner = document.createElement('div');
            borderInner.className = 'certificate-border-inner';
            borderContainer.appendChild(borderInner);

            // ì¥ì‹ì ì¸ ê³¡ì„  ìš”ì†Œ ì¶”ê°€
            const decorationPositions = ['top', 'bottom', 'left', 'right'];
            decorationPositions.forEach(position => {
                const decoration = document.createElement('div');
                decoration.className = `certificate-border-decoration decoration-${position}`;
                borderContainer.appendChild(decoration);
            });

            // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            container.appendChild(borderContainer);

            // ì •ë¦¬ë¥¼ ìœ„í•œ í•¨ìˆ˜ ë°˜í™˜
            return function () {
                // ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
                document.head.removeChild(styleTag);
            };
        },

        /**
         * í•œê¸€ ìê²©ì¦ PDF ìƒì„±
         */
        generateKoreanCertPdf: async function (certId) {
            try {
                // ìê²©ì¦ ì •ë³´ ì¡°íšŒ
                let cert = null;
                let courseName = '';

                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    try {
                        const docRef = window.dhcFirebase.db.collection('certificates').doc(certId);
                        const docSnap = await docRef.get();

                        if (docSnap.exists) {
                            cert = {
                                id: docSnap.id,
                                ...docSnap.data()
                            };

                            // êµìœ¡ ê³¼ì • ì •ë³´ ì¡°íšŒ
                            if (cert.courseId) {
                                try {
                                    const courseRef = window.dhcFirebase.db.collection('courses').doc(cert.courseId);
                                    const courseSnap = await courseRef.get();

                                    if (courseSnap.exists) {
                                        courseName = courseSnap.data().title || '';
                                    }
                                } catch (error) {
                                    console.error('êµìœ¡ ê³¼ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
                                }
                            }
                        } else {
                            window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('ìê²©ì¦ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                    cert = this.getMockCertificateById(certId);
                    if (!cert) {
                        window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }

                    courseName = cert.course || 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ ê³¼ì •';
                }

                // ìê²©ì¦ ì •ë³´ ì¶”ì¶œ
                const certNumber = cert.certificateNumber || cert.certNumber || 'XX-0000-0000';
                const holderName = cert.holderName || cert.name || 'í™ê¸¸ë™';
                // ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                const issueDate = this.formatDate(cert.issueDate) || '2025-05-01';
                const certType = this.getCertTypeName(cert.certificateType || this.currentCertType);

                // ë°œê¸‰ì¼ í¬ë§·íŒ… - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                const today = new Date();
                const formattedToday = window.formatters.formatDate(today, 'YYYYë…„ MMì›” DDì¼');

                // ì§ì¸ ë° ë°°ê²½ ì´ë¯¸ì§€ ê²½ë¡œ
                const sealImagePath = window.adjustPath('assets/images/logo/seal.png'); // ì‹¤ì œ ì§ì¸ ì´ë¯¸ì§€ ê²½ë¡œ
                const borderImagePath = window.adjustPath('assets/images/certificates/border-gold.png'); // í…Œë‘ë¦¬ ì´ë¯¸ì§€ (ì²¨ë¶€í•œ ì´ë¯¸ì§€ì²˜ëŸ¼)
                const logoImagePath = window.adjustPath('assets/images/logo/logo.jpeg'); // ë¡œê³  ì´ë¯¸ì§€

                // HTML í…œí”Œë¦¿ ìƒì„± (í•œê¸€ ìê²©ì¦)
                const certTemplate = document.createElement('div');
                certTemplate.style.width = '793px'; // A4 ë„ˆë¹„ (px)
                certTemplate.style.height = '1122px'; // A4 ë†’ì´ (px)
                certTemplate.style.position = 'absolute';
                certTemplate.style.left = '-9999px';
                certTemplate.style.fontFamily = 'Noto Sans KR, sans-serif';
                certTemplate.style.padding = '0';
                certTemplate.style.boxSizing = 'border-box';
                certTemplate.style.textAlign = 'center';
                certTemplate.style.color = '#000';
                certTemplate.style.backgroundColor = '#FFF';
                certTemplate.style.border = '15px solid #1e3a8a'; // íŒŒë€ìƒ‰ í…Œë‘ë¦¬
                certTemplate.style.overflow = 'hidden'; // ë‚´ë¶€ ìš”ì†Œê°€ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ì„¤ì •

                // í…Œë‘ë¦¬ ì´ë¯¸ì§€ ë˜ëŠ” CSS í…Œë‘ë¦¬ ì¶”ê°€
                let borderImgLoadFailed = false;
                const borderImg = document.createElement('div');
                borderImg.style.position = 'absolute';
                borderImg.style.top = '0';
                borderImg.style.left = '0';
                borderImg.style.right = '0';
                borderImg.style.bottom = '0';
                borderImg.style.zIndex = '1';

                // ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„
                const img = new Image();
                img.onload = () => {
                    borderImg.style.backgroundImage = `url('${borderImagePath}')`;
                    borderImg.style.backgroundPosition = 'center';
                    borderImg.style.backgroundSize = 'contain';
                    borderImg.style.backgroundRepeat = 'no-repeat';
                    certTemplate.appendChild(borderImg);
                };
                img.onerror = () => {
                    console.log('í…Œë‘ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨. CSS í…Œë‘ë¦¬ ì‚¬ìš©.');
                    borderImgLoadFailed = true;
                    // CSS ê¸°ë°˜ í…Œë‘ë¦¬ ìƒì„±
                    this.createCSSDerivedBorder(certTemplate);
                };
                img.src = borderImagePath;

                // í…Œë‘ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì•ˆë˜ë©´ CSS í…Œë‘ë¦¬ ì ìš©
                if (img.complete && img.naturalWidth === 0) {
                    console.log('í…Œë‘ë¦¬ ì´ë¯¸ì§€ ì¦‰ì‹œ ë¡œë“œ ì‹¤íŒ¨. CSS í…Œë‘ë¦¬ ì‚¬ìš©.');
                    borderImgLoadFailed = true;
                    this.createCSSDerivedBorder(certTemplate);
                } else if (img.complete) {
                    // ì´ë¯¸ ìºì‹œëœ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ë°”ë¡œ ì ìš©
                    borderImg.style.backgroundImage = `url('${borderImagePath}')`;
                    borderImg.style.backgroundPosition = 'center';
                    borderImg.style.backgroundSize = 'contain';
                    borderImg.style.backgroundRepeat = 'no-repeat';
                    certTemplate.appendChild(borderImg);
                }

                // ë‚´ìš© ì»¨í…Œì´ë„ˆ (z-indexë¥¼ ë†’ì—¬ í…Œë‘ë¦¬ ìœ„ì— í‘œì‹œ)
                const contentContainer = document.createElement('div');
                contentContainer.style.position = 'relative';
                contentContainer.style.zIndex = '2';
                contentContainer.style.height = '100%';
                contentContainer.style.width = '100%';
                contentContainer.style.padding = '80px 100px';
                contentContainer.style.boxSizing = 'border-box';
                contentContainer.style.display = 'flex';
                contentContainer.style.flexDirection = 'column';
                contentContainer.style.justifyContent = 'space-between';

                // ìê²©ì¦ ì œëª© ë° ì •ë³´
                const headerDiv = document.createElement('div');
                headerDiv.style.textAlign = 'center';
                headerDiv.style.marginBottom = '40px';

                // ì œëª© (ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬)
                const titleH1 = document.createElement('h1');
                titleH1.textContent = certType;
                titleH1.style.fontSize = '36px';
                titleH1.style.fontWeight = 'bold';
                titleH1.style.color = '#1e3a8a';
                titleH1.style.marginBottom = '10px';
                headerDiv.appendChild(titleH1);

                // ì˜ë¬¸ ì œëª© (Pilates Specialist)
                const subtitleH2 = document.createElement('h2');
                subtitleH2.textContent = 'Pilates Specialist';
                subtitleH2.style.fontSize = '20px';
                subtitleH2.style.color = '#333';
                subtitleH2.style.marginBottom = '50px';
                headerDiv.appendChild(subtitleH2);

                // ìê²©ì¦ ì •ë³´ (ì¸ì¦ë²ˆí˜¸, ì„±ëª…, ê¸‰ìˆ˜, ì·¨ë“ì¼ì)
                const infoDiv = document.createElement('div');
                infoDiv.style.textAlign = 'left';
                infoDiv.style.position = 'relative';
                infoDiv.style.marginBottom = '50px';

                // ì •ë³´ í•­ëª©ë“¤
                const infoItems = [
                    { label: 'ì¸ì¦ë²ˆí˜¸', value: certNumber },
                    { label: 'ì„±    ëª…', value: holderName },
                    { label: 'ê¸‰    ìˆ˜', value: '1ê¸‰' },
                    { label: 'ì·¨ë“ì¼ì', value: issueDate }
                ];

                infoItems.forEach(item => {
                    const infoPara = document.createElement('p');
                    infoPara.style.margin = '15px 0';
                    infoPara.style.fontSize = '16px';
                    infoPara.style.lineHeight = '1.5';

                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = `${item.label} : `;
                    labelSpan.style.fontWeight = '500';

                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = item.value;
                    valueSpan.style.fontWeight = '600';

                    infoPara.appendChild(labelSpan);
                    infoPara.appendChild(valueSpan);
                    infoDiv.appendChild(infoPara);
                });

                // ì‚¬ì§„ ì˜ì—­
                const photoDiv = document.createElement('div');
                photoDiv.style.position = 'absolute';
                photoDiv.style.top = '0';
                photoDiv.style.right = '0';
                photoDiv.style.width = '120px';
                photoDiv.style.height = '150px';
                photoDiv.style.border = '1px solid #000';
                photoDiv.style.display = 'flex';
                photoDiv.style.alignItems = 'center';
                photoDiv.style.justifyContent = 'center';
                photoDiv.style.backgroundColor = '#f8f8f8';

                const photoText = document.createElement('p');
                photoText.textContent = 'ì‚¬ì§„';
                photoText.style.fontSize = '14px';
                photoText.style.color = '#888';
                photoDiv.appendChild(photoText);
                infoDiv.appendChild(photoDiv);

                // ì¸ì¦ ë¬¸êµ¬
                const certTextDiv = document.createElement('div');
                certTextDiv.style.textAlign = 'center';
                certTextDiv.style.margin = '60px 0';
                certTextDiv.style.fontSize = '18px';
                certTextDiv.style.lineHeight = '1.8';

                const certText = document.createElement('div');
                certText.innerHTML = `
                <p>ë³¸ ì‚¬í•­ì€ ${certType} 1ê¸‰ êµìœ¡ê³¼ì •ì„</p>
                <p>ì´ìˆ˜í•˜ê³  ì´ë¡  ë° ì‹¤ê¸° ì‹¬ì‚¬ì— í†µê³¼í•˜ì˜€ìœ¼ë¯€ë¡œ</p>
                <p>ìê²©ì¦ì„ ìˆ˜ì—¬í•©ë‹ˆë‹¤.</p>
            `;
                certTextDiv.appendChild(certText);

                // í•˜ë‹¨ ë°œê¸‰ ì •ë³´ (ë‚ ì§œ, ê¸°ê´€ëª…, ì§ì¸)
                const footerDiv = document.createElement('div');
                footerDiv.style.marginTop = 'auto';
                footerDiv.style.width = '100%';
                footerDiv.style.position = 'relative';

                // ë°œê¸‰ì¼ (ì˜¤ë¥¸ìª½ ì •ë ¬)
                const dateDiv = document.createElement('div');
                dateDiv.style.textAlign = 'right';
                dateDiv.style.marginBottom = '30px';

                const dateText = document.createElement('p');
                dateText.textContent = formattedToday;
                dateText.style.fontSize = '16px';
                dateDiv.appendChild(dateText);
                footerDiv.appendChild(dateDiv);

                // ë°œê¸‰ ê¸°ê´€ëª…ê³¼ ì§ì¸ ì»¨í…Œì´ë„ˆ (ì¤‘ì•™ ì •ë ¬)
                const orgContainer = document.createElement('div');
                orgContainer.style.position = 'relative';
                orgContainer.style.width = '100%';
                orgContainer.style.textAlign = 'center';
                orgContainer.style.paddingBottom = '20px';

                // ê¸°ê´€ëª…
                const orgText = document.createElement('p');
                orgText.textContent = '(ì‚¬)ë¬¸ê²½ ë¶€ì„¤ ë””ì§€í„¸í—¬ìŠ¤ì¼€ì–´ì„¼í„°';
                orgText.style.fontSize = '20px';
                orgText.style.fontWeight = 'bold';
                orgText.style.paddingRight = '30px'; // ì§ì¸ ê³µê°„ í™•ë³´
                orgContainer.appendChild(orgText);

                // ì§ì¸ ì´ë¯¸ì§€ - PDF ë ˆì´ì•„ì›ƒì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
                const sealImg = document.createElement('img');
                sealImg.src = sealImagePath;
                sealImg.style.position = 'absolute';
                sealImg.style.width = '80px';
                sealImg.style.height = '80px';
                sealImg.style.right = '10px';  // ì˜¤ë¥¸ìª½ ì •ë ¬
                sealImg.style.bottom = '0px';  // í•˜ë‹¨ ì •ë ¬
                sealImg.style.opacity = '0.9';
                sealImg.style.zIndex = '3';
                orgContainer.appendChild(sealImg);

                footerDiv.appendChild(orgContainer);

                // êµ¬ì„± ìš”ì†Œ ì¶”ê°€
                contentContainer.appendChild(headerDiv);
                contentContainer.appendChild(infoDiv);
                contentContainer.appendChild(certTextDiv);
                contentContainer.appendChild(footerDiv);

                certTemplate.appendChild(contentContainer);
                document.body.appendChild(certTemplate);

                try {
                    // ì´ë¯¸ì§€ ë¡œë”© ê¸°ë‹¤ë¦¬ê¸°
                    await new Promise((resolve) => {
                        // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                        const images = certTemplate.querySelectorAll('img');
                        let loadedCount = 0;

                        const checkComplete = () => {
                            loadedCount++;
                            if (loadedCount === images.length) resolve();
                        };

                        // ì´ë¯¸ ë¡œë“œëœ ì´ë¯¸ì§€ ì²˜ë¦¬
                        images.forEach(img => {
                            if (img.complete) {
                                checkComplete();
                            } else {
                                img.onload = checkComplete;
                                img.onerror = () => {
                                    console.error(`ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${img.src}`);
                                    checkComplete();
                                };
                            }
                        });

                        // ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° ë°”ë¡œ í•´ê²°
                        if (images.length === 0) resolve();

                        // ì•ˆì „ì¥ì¹˜: ìµœëŒ€ 3ì´ˆ í›„ ê³„ì† ì§„í–‰
                        setTimeout(resolve, 3000);
                    });

                    // html2canvas ì˜µì…˜ - ì´ë¯¸ì§€ ë¡œë”©ì„ ìœ„í•œ ì¶©ë¶„í•œ ì‹œê°„ í™•ë³´
                    const canvasOptions = {
                        scale: 2, // ê³ í•´ìƒë„
                        logging: true, // ë””ë²„ê¹…ì„ ìœ„í•´ ë¡œê¹… í™œì„±í™”
                        useCORS: true, // ì™¸ë¶€ ì´ë¯¸ì§€ í—ˆìš©
                        allowTaint: true, // ì™¸ë¶€ ì´ë¯¸ì§€ í—ˆìš©
                        backgroundColor: "#ffffff", // ë°°ê²½ìƒ‰ ì§€ì •
                        imageTimeout: 5000, // ì´ë¯¸ì§€ ë¡œë”© íƒ€ì„ì•„ì›ƒ ì¦ê°€
                        onclone: (clonedDoc) => {
                            // ë³µì œëœ ìš”ì†Œì—ì„œ ì´ë¯¸ì§€ ë°ì´í„° í™•ì¸
                            console.log('í´ë¡  ë¬¸ì„œì—ì„œ ì´ë¯¸ì§€ í™•ì¸:',
                                clonedDoc.querySelectorAll('img').length);
                        }
                    };

                    // html2canvasë¡œ PDF ìƒì„±
                    const canvas = await html2canvas(certTemplate, canvasOptions);

                    // PDF ìƒì„±
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');

                    // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ PDFì— ì¶”ê°€
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = doc.internal.pageSize.getWidth();
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                    // PDF ì €ì¥
                    doc.save(`${certType}_${holderName}_${certNumber}_í•œê¸€.pdf`);

                    window.adminAuth?.showNotification('í•œê¸€ ìê²©ì¦ PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error('HTMLì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜ ì¤‘ ì˜¤ë¥˜:', error);
                    window.adminAuth?.showNotification('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

                // ì„ì‹œ í…œí”Œë¦¿ ì œê±°
                document.body.removeChild(certTemplate);

            } catch (error) {
                console.error('í•œê¸€ PDF ìƒì„± ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },

        /**
         * ì˜ë¬¸ ìê²©ì¦ PDF ìƒì„± (ê°„ëµí™”)
         */
        generateEnglishCertPdf: async function (certId) {
            try {
                // ìê²©ì¦ ì •ë³´ ì¡°íšŒ (í•œê¸€ê³¼ ë™ì¼í•œ ë¡œì§)
                let cert = this.getMockCertificateById(certId);
                if (!cert) {
                    window.adminAuth?.showNotification('ìê²©ì¦ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                // PDF ìƒì„± (ê°„ë‹¨í•œ ì˜ë¬¸ ë²„ì „)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('CERTIFICATE', 105, 40, { align: 'center' });
                doc.setFontSize(16);
                doc.text('Health Exercise Specialist', 105, 60, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Certificate No: ${cert.certificateNumber || cert.certNumber}`, 20, 100);
                doc.text(`Name: ${cert.holderName || cert.name}`, 20, 120);
                doc.text(`Issue Date: ${cert.issueDate}`, 20, 140);

                doc.save(`Certificate_${cert.holderName || cert.name}_English.pdf`);
                window.adminAuth?.showNotification('ì˜ë¬¸ ìê²©ì¦ PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error('ì˜ë¬¸ PDF ìƒì„± ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        },

        /**
         * ìê²©ì¦ ì·¨ì†Œ
         */
        revokeCertificate: function (certId) {
            if (window.adminUtils?.confirmDialog) {
                window.adminUtils.confirmDialog(
                    'ì •ë§ë¡œ ì´ ìê²©ì¦ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    `certManager.handleRevokeCertificate('${certId}')`
                );
            } else {
                if (confirm('ì •ë§ë¡œ ì´ ìê²©ì¦ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    this.handleRevokeCertificate(certId);
                }
            }
        },

        /**
         * ìê²©ì¦ ì·¨ì†Œ ì²˜ë¦¬
         */
        handleRevokeCertificate: async function (certId) {
            try {
                // ë¡œë”© í‘œì‹œ
                if (window.adminUtils?.showLoadingOverlay) {
                    window.adminUtils.showLoadingOverlay(true);
                }

                // Firebase ì—°ë™ ì‹œ
                const firebaseStatus = checkFirebaseConnection();
                if (firebaseStatus.connected) {
                    // ì—…ë°ì´íŠ¸ ë°ì´í„°
                    const updateData = {
                        status: 'revoked',
                        revokedAt: window.dhcFirebase.firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: window.dhcFirebase.firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Firebaseì— ì—…ë°ì´íŠ¸
                    try {
                        const docRef = window.dhcFirebase.db.collection('certificates').doc(certId);
                        await docRef.update(updateData);

                        // ì„±ê³µ ë©”ì‹œì§€
                        window.adminAuth?.showNotification('ìê²©ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    } catch (error) {
                        console.error('ìê²©ì¦ ì·¨ì†Œ ì˜¤ë¥˜:', error);
                        window.adminAuth?.showNotification('ìê²©ì¦ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } else {
                    // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                    setTimeout(() => {
                        // ì„±ê³µ ë©”ì‹œì§€
                        window.adminAuth?.showNotification('ìê²©ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        this.loadCertificates();
                    }, 1000);
                }
            } catch (error) {
                console.error('ìê²©ì¦ ì·¨ì†Œ ì˜¤ë¥˜:', error);
                window.adminAuth?.showNotification('ìê²©ì¦ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                // ë¡œë”© ì¢…ë£Œ
                if (window.adminUtils?.showLoadingOverlay) {
                    window.adminUtils.showLoadingOverlay(false);
                }
            }
        },

        // =================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
        // =================================

        /**
         * ìƒíƒœ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
         */
        getStatusText: function (status) {
            switch (status) {
                case 'active': return 'ìœ íš¨';
                case 'expired': return 'ë§Œë£Œ';
                case 'revoked': return 'ì·¨ì†Œ';
                case 'suspended': return 'ì •ì§€';
                default: return status || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        },

        /**
         * ìê²©ì¦ ìœ í˜• ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (í•œê¸€)
         */
        getCertTypeName: function (type) {
            switch (type) {
                case 'health-exercise': return 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬';
                case 'rehabilitation': return 'ìš´ë™ì¬í™œì „ë¬¸ê°€';
                case 'pilates': return 'í•„ë¼í…ŒìŠ¤ ì „ë¬¸ê°€';
                case 'recreation': return 'ë ˆí¬ë¦¬ì—ì´ì…˜ì§€ë„ì';
                default: return type || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        },

        /**
         * ìê²©ì¦ ìœ í˜• ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì˜ë¬¸)
         */
        getCertTypeNameEn: function (type) {
            switch (type) {
                case 'health-exercise': return 'Health Exercise Specialist';
                case 'rehabilitation': return 'Exercise Rehabilitation Specialist';
                case 'pilates': return 'Pilates Specialist';
                case 'recreation': return 'Recreation Instructor';
                default: return type || 'Unknown';
            }
        },

        /**
         * ë‚ ì§œ í¬ë§·íŒ… - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
         */
        formatDate: function (date, includeTime = false) {
            if (!date) return '-';

            try {
                // Firebase Timestampì¸ ê²½ìš°
                if (typeof date.toDate === 'function') {
                    date = date.toDate();
                } else if (typeof date === 'string') {
                    // ì´ë¯¸ ë¬¸ìì—´ í˜•íƒœì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
                    return date;
                }

                // Date ê°ì²´ì¸ ê²½ìš° - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                if (date instanceof Date) {
                    if (includeTime) {
                        return window.formatters.formatDate(date, 'YYYY-MM-DD HH:mm');
                    } else {
                        return window.formatters.formatDate(date, 'YYYY-MM-DD');
                    }
                }
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
            }

            return '-';
        },

        /**
         * ë‚ ì§œë¥¼ input[type="date"]ìš©ìœ¼ë¡œ í¬ë§·íŒ… - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
         */
        formatDateToInput: function (date) {
            if (!date) return '';

            try {
                // Firebase Timestampì¸ ê²½ìš°
                if (typeof date.toDate === 'function') {
                    date = date.toDate();
                } else if (typeof date === 'string') {
                    // YYYY-MM-DD í˜•ì‹ì¸ì§€ í™•ì¸
                    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                        return date;
                    }
                    // ë‹¤ë¥¸ í˜•ì‹ì˜ ë¬¸ìì—´ì¼ ê²½ìš° Date ê°ì²´ë¡œ ë³€í™˜
                    date = new Date(date);
                }

                // Date ê°ì²´ì¸ ê²½ìš° - ğŸ”§ ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
                if (date instanceof Date) {
                    return window.formatters.formatDate(date, 'YYYY-MM-DD');
                }
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
            }

            return '';
        },

        /**
         * í…ŒìŠ¤íŠ¸ìš© ëª¨ì˜ ìê²©ì¦ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
         */
        getMockCertificates: function () {
            // Firebase ì—°ë™ ì „ í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°
            return [
                {
                    id: 'cert1',
                    certNumber: 'HE-2025-0001',
                    name: 'í™ê¸¸ë™',
                    course: 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 1ê¸°',
                    issueDate: '2025-03-15',
                    expiryDate: '2028-03-14',
                    status: 'active',
                    remarks: 'ìµœìš°ìˆ˜ ì„±ì ìœ¼ë¡œ ìˆ˜ë£Œ'
                },
                {
                    id: 'cert2',
                    certNumber: 'HE-2025-0002',
                    name: 'ê¹€ì² ìˆ˜',
                    course: 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 1ê¸°',
                    issueDate: '2025-03-15',
                    expiryDate: '2028-03-14',
                    status: 'active',
                    remarks: ''
                },
                {
                    id: 'cert3',
                    certNumber: 'HE-2024-0035',
                    name: 'ì´ì˜í¬',
                    course: 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 4ê¸°',
                    issueDate: '2024-12-20',
                    expiryDate: '2027-12-19',
                    status: 'active',
                    remarks: ''
                },
                {
                    id: 'cert4',
                    certNumber: 'HE-2024-0012',
                    name: 'ë°•ì§€ë¯¼',
                    course: 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 2ê¸°',
                    issueDate: '2024-06-30',
                    expiryDate: '2024-06-29',
                    status: 'expired',
                    remarks: 'ë§Œë£Œë¨'
                },
                {
                    id: 'cert5',
                    certNumber: 'HE-2024-0018',
                    name: 'ìµœë¯¼ìˆ˜',
                    course: 'ê±´ê°•ìš´ë™ì²˜ë°©ì‚¬ 3ê¸°',
                    issueDate: '2024-09-15',
                    expiryDate: '2027-09-14',
                    status: 'suspended',
                    remarks: 'ìœ„ë°˜ í–‰ìœ„ë¡œ ì¸í•œ ìê²© ì •ì§€'
                }
            ];
        },

        /**
         * IDë¡œ í…ŒìŠ¤íŠ¸ìš© ëª¨ì˜ ìê²©ì¦ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
         */
        getMockCertificateById: function (certId) {
            const certs = this.getMockCertificates();
            return certs.find(cert => cert.id === certId) || null;
        }
    };

    // ìê²©ì¦ ê´€ë¦¬ì ì´ˆê¸°í™”
    window.certManager.init();
}

// í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜ (script-loader.jsì— ì˜í•´ í˜¸ì¶œë¨)
window.initPage = function () {
    console.log('ìê²©ì¦ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘...');
    // ì¶”ê°€ ì´ˆê¸°í™” ë¡œì§ (í•„ìš”ì‹œ)
    console.log('ìê²©ì¦ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
};

// =================================
// ë””ë²„ê¹… ë° ê°œë°œì ë„êµ¬
// =================================

// ê°œë°œ ëª¨ë“œì—ì„œ ì‚¬ìš©ë˜ëŠ” ë””ë²„ê¹… í•¨ìˆ˜ë“¤
if (window.location.hostname === 'localhost' ||
    window.location.hostname === '127.0.0.1' ||
    window.location.hostname.includes('.web.app') ||
    window.location.hostname.includes('.firebaseapp.com') ||
    window.location.protocol === 'file:' ||
    window.FORCE_DEBUG === true) {

    window.debugCertManagement = {
        // ê¸°ë³¸ ì •ë³´ í™•ì¸
        help: function () {
            console.log('ğŸ¯ ìê²©ì¦ ê´€ë¦¬ ë””ë²„ê¹… ë„êµ¬ ì‚¬ìš©ë²•');
            console.log('\nğŸ“Š ë°ì´í„° ê´€ë ¨:');
            console.log('- showCertificates() : í˜„ì¬ ìê²©ì¦ ëª©ë¡');
            console.log('- reloadCertList() : ìê²©ì¦ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ');
            console.log('- testDependencies() : ìœ í‹¸ë¦¬í‹° ì˜ì¡´ì„± í™•ì¸');
            console.log('- checkFirebase() : Firebase ì—°ê²° ìƒíƒœ í™•ì¸');

            console.log('\nğŸ¯ ì„ íƒ ê´€ë ¨:');
            console.log('- switchCertType("cert-type") : ìê²©ì¦ ìœ í˜• ì „í™˜');
            console.log('- testSearch("keyword") : ê²€ìƒ‰ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸');

            console.log('\nğŸ“ ë°œê¸‰ ê´€ë ¨:');
            console.log('- fillTestIssuanceData() : í…ŒìŠ¤íŠ¸ ë°œê¸‰ ë°ì´í„° ì…ë ¥');
            console.log('- simulateIssuance() : ìê²©ì¦ ë°œê¸‰ ì‹œë®¬ë ˆì´ì…˜');

            console.log('\nğŸ“„ PDF ê´€ë ¨:');
            console.log('- testPdfGeneration("cert-id") : PDF ìƒì„± í…ŒìŠ¤íŠ¸');
            console.log('- downloadTestPdf("ko"|"en") : í…ŒìŠ¤íŠ¸ PDF ë‹¤ìš´ë¡œë“œ');

            console.log('\nğŸ§ª ì¢…í•© í…ŒìŠ¤íŠ¸:');
            console.log('- runFullTest() : ì „ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸');

            console.log('\nğŸ”§ PDF ë“œë¡­ë‹¤ìš´ í…ŒìŠ¤íŠ¸:');
            console.log('- testPdfDropdown() : PDF ë“œë¡­ë‹¤ìš´ z-index í…ŒìŠ¤íŠ¸');
        },

        // ğŸ”§ PDF ë“œë¡­ë‹¤ìš´ í…ŒìŠ¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
        testPdfDropdown: function () {
            console.log('ğŸ”§ PDF ë“œë¡­ë‹¤ìš´ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            // ì²« ë²ˆì§¸ PDF ë²„íŠ¼ ì°¾ê¸°
            const pdfBtn = document.querySelector('.cert-pdf-btn');
            if (pdfBtn) {
                console.log('âœ… PDF ë²„íŠ¼ ë°œê²¬, í´ë¦­ ì‹œë®¬ë ˆì´ì…˜');
                pdfBtn.click();

                setTimeout(() => {
                    const dropdown = document.querySelector('.cert-pdf-menu:not(.hidden)');
                    if (dropdown) {
                        console.log('âœ… ë“œë¡­ë‹¤ìš´ í‘œì‹œë¨');
                        const computedStyle = window.getComputedStyle(dropdown);
                        console.log('ë“œë¡­ë‹¤ìš´ z-index:', computedStyle.zIndex);
                        console.log('ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜:', computedStyle.position);
                        console.log('ë“œë¡­ë‹¤ìš´ í‘œì‹œ ìƒíƒœ:', computedStyle.visibility, computedStyle.opacity);
                    } else {
                        console.log('âŒ ë“œë¡­ë‹¤ìš´ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ');
                    }
                }, 100);
            } else {
                console.log('âŒ PDF ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
        },

        // ğŸ”§ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸
        testDependencies: function () {
            console.log('ğŸ”§ ìœ í‹¸ë¦¬í‹° ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸...');
            const result = checkDependencies();
            if (result) {
                console.log('âœ… ëª¨ë“  ìœ í‹¸ë¦¬í‹° ì •ìƒ ë¡œë“œë¨');

                // ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
                try {
                    const testDate = new Date();
                    console.log('ğŸ“… formatters.formatDate í…ŒìŠ¤íŠ¸:', window.formatters.formatDate(testDate, 'YYYY.MM.DD'));
                    console.log('ğŸ’° formatters.formatCurrency í…ŒìŠ¤íŠ¸:', window.formatters.formatCurrency(350000));
                    console.log('ğŸ“ formatters.formatPhoneNumber í…ŒìŠ¤íŠ¸:', window.formatters.formatPhoneNumber('01012345678'));
                    if (window.dateUtils) {
                        console.log('ğŸ•’ dateUtils.format í…ŒìŠ¤íŠ¸:', window.dateUtils.format(testDate, 'YYYY-MM-DD'));
                        console.log('ğŸ—“ï¸ dateUtils.addYears í…ŒìŠ¤íŠ¸:', window.dateUtils.addYears(testDate, 3));
                    }
                } catch (error) {
                    console.error('âŒ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                }
            } else {
                console.error('âŒ í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° ëˆ„ë½');
            }
            return result;
        },

        // Firebase ì—°ê²° í™•ì¸
        checkFirebase: function () {
            console.log('ğŸ”¥ Firebase ì—°ê²° ìƒíƒœ í™•ì¸...');
            const status = checkFirebaseConnection();
            console.log('ì—°ê²° ìƒíƒœ:', status);
            return status;
        },

        // ì¢…í•© í…ŒìŠ¤íŠ¸
        runFullTest: function () {
            console.log('ğŸš€ ìê²©ì¦ ê´€ë¦¬ ì „ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            console.log('\n1ï¸âƒ£ ì˜ì¡´ì„± ë° ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸');
            const dependenciesOk = this.testDependencies();

            if (!dependenciesOk) {
                console.error('âŒ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨');
                return;
            }

            console.log('\n2ï¸âƒ£ Firebase ì—°ê²° ìƒíƒœ í™•ì¸');
            this.checkFirebase();

            console.log('\n3ï¸âƒ£ PDF ë“œë¡­ë‹¤ìš´ í…ŒìŠ¤íŠ¸');
            this.testPdfDropdown();

            console.log('\nğŸ¯ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
            console.log('ğŸ’¡ ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì„ ì‹œë„í•´ë³´ì„¸ìš”:');
            console.log('- testPdfDropdown() : PDF ë“œë¡­ë‹¤ìš´ z-index í…ŒìŠ¤íŠ¸');
        }
    };

    // ë””ë²„ê¹… ë„êµ¬ ì•ˆë‚´
    console.log('ğŸ¯ ê°œë°œ ëª¨ë“œ ìê²©ì¦ ê´€ë¦¬ ë””ë²„ê¹… ë„êµ¬ í™œì„±í™”ë¨ (PDF ì•„ì´ì½˜ ìˆ˜ì • ì™„ë£Œ)');
    console.log('í˜„ì¬ í˜¸ìŠ¤íŠ¸:', window.location.hostname);
    console.log('\nğŸ”¥ ì£¼ìš” ë””ë²„ê¹… í•¨ìˆ˜ë“¤:');
    console.log('ğŸ“Š ë°ì´í„°: testDependencies(), checkFirebase()');
    console.log('ğŸ”§ PDF í…ŒìŠ¤íŠ¸: testPdfDropdown()');
    console.log('ğŸ§ª ì¢…í•©: runFullTest()');
    console.log('\nğŸ’¡ ë„ì›€ë§: window.debugCertManagement.help()');
    console.log('ğŸš€ ë¹ ë¥¸ ì‹œì‘: window.debugCertManagement.runFullTest()');

} else {
    console.log('í”„ë¡œë•ì…˜ ëª¨ë“œ - ë””ë²„ê¹… ë„êµ¬ ë¹„í™œì„±í™”ë¨');
    console.log('í˜„ì¬ í˜¸ìŠ¤íŠ¸:', window.location.hostname);
}

// =================================
// ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€
// =================================

console.log('\nğŸ‰ === cert-management.js PDF ì•„ì´ì½˜ ìˆ˜ì • ì™„ë£Œ ===');
console.log('âœ… PDF ì•„ì´ì½˜: ë‹¤ìš´ë¡œë“œ í™”ì‚´í‘œ â†’ PDF íŒŒì¼ ì•„ì´ì½˜ êµì²´ ì™„ë£Œ');
console.log('âœ… PDF ë“œë¡­ë‹¤ìš´ z-index ìˆ˜ì • ì™„ë£Œ');
console.log('âœ… ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€ ì‹œìŠ¤í…œ ì¶”ê°€');
console.log('âœ… ì „ì—­ ìœ í‹¸ë¦¬í‹° ì‹œìŠ¤í…œ í†µí•© ìœ ì§€');
console.log('âœ… Firebase ì—°ê²° ìƒíƒœ í™•ì¸ ê°•í™” ìœ ì§€');
console.log('âœ… ë””ë²„ê¹… ë„êµ¬ ì‹œìŠ¤í…œ ê°œì„ ');
console.log('\nğŸ”§ í•´ê²°ëœ ë¬¸ì œ:');
console.log('- PDF ë²„íŠ¼ ì•„ì´ì½˜ì´ ì§ê´€ì ì¸ PDF íŒŒì¼ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½');
console.log('- PDF ë“œë¡­ë‹¤ìš´ì´ í…Œì´ë¸”ì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ z-index ìˆ˜ì •');
console.log('- ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€');
console.log('\nğŸš€ ëª¨ë“  PDF ê´€ë ¨ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!');

// ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
window.certManagementPdfFixed = true;