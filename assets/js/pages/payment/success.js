/**
 * success.js - Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î¶ΩÌä∏ (ÏôÑÏ†ÑÌïú Î≤ÑÏ†Ñ)
 * ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏÑ±Í≥µ ÌõÑ Ï≤òÎ¶¨ Î°úÏßÅ
 */

console.log('=== Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄ Î°úÎìúÎê® ===');

// =================================
// Ï†ÑÏó≠ Î≥ÄÏàò
// =================================

let paymentData = null;
let applicationData = null;

// =================================
// Ï¥àÍ∏∞Ìôî
// =================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üéâ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî');
    
    // URL ÌååÎùºÎØ∏ÌÑ∞ ÌååÏã±
    const urlParams = new URLSearchParams(window.location.search);
    const paymentKey = urlParams.get('paymentKey');
    const orderId = urlParams.get('orderId');
    const amount = urlParams.get('amount');
    
    console.log('üìã URL ÌååÎùºÎØ∏ÌÑ∞:', { paymentKey, orderId, amount });
    
    if (paymentKey && orderId && amount) {
        // ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏäπÏù∏ Ï≤òÎ¶¨
        confirmPayment(paymentKey, orderId, parseInt(amount));
    } else {
        // ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ïò§Î•ò Ï≤òÎ¶¨
        showError('Í≤∞Ï†ú Ï†ïÎ≥¥Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
    }
});

// =================================
// Í≤∞Ï†ú ÏäπÏù∏ Ï≤òÎ¶¨
// =================================

/**
 * ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏäπÏù∏
 */
async function confirmPayment(paymentKey, orderId, amount) {
    try {
        console.log('‚úÖ ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏäπÏù∏ ÏãúÏûë:', { paymentKey, orderId, amount });
        
        // payment-service Ï¥àÍ∏∞Ìôî ÌôïÏù∏
        if (!window.paymentService || !window.paymentService.isInitialized) {
            console.log('‚ö†Ô∏è payment-service Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞...');
            await waitForPaymentService();
        }
        
        // ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏäπÏù∏ ÏöîÏ≤≠
        const confirmResult = await window.paymentService.confirmPayment(paymentKey, orderId, amount);
        
        if (confirmResult.success) {
            console.log('‚úÖ Í≤∞Ï†ú ÏäπÏù∏ ÏÑ±Í≥µ:', confirmResult.data);
            paymentData = confirmResult.data;
            
            // Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏóÖÎç∞Ïù¥Ìä∏
            await loadAndUpdateApplicationData();
            
            // ÏÑ±Í≥µ ÌôîÎ©¥ ÌëúÏãú
            showSuccessResult();
            
        } else {
            throw new Error(confirmResult.error || 'Í≤∞Ï†ú ÏäπÏù∏ Ïã§Ìå®');
        }
        
    } catch (error) {
        console.error('‚ùå Í≤∞Ï†ú ÏäπÏù∏ Ïò§Î•ò:', error);
        showError('Í≤∞Ï†ú ÏäπÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
    }
}

/**
 * payment-service Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
 */
function waitForPaymentService() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        function check() {
            attempts++;
            
            if (window.paymentService && window.paymentService.isInitialized) {
                console.log('‚úÖ payment-service Ï§ÄÎπÑÎê®');
                resolve();
                return;
            }
            
            if (attempts < maxAttempts) {
                setTimeout(check, 100);
            } else {
                reject(new Error('payment-service Ï¥àÍ∏∞Ìôî ÏãúÍ∞Ñ Ï¥àÍ≥º'));
            }
        }
        
        check();
    });
}

/**
 * Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏóÖÎç∞Ïù¥Ìä∏
 */
async function loadAndUpdateApplicationData() {
    try {
        console.log('üìÑ Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è ÏóÖÎç∞Ïù¥Ìä∏');
        
        // Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÏÑú Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        const pendingOrderStr = localStorage.getItem('dhc_pending_order');
        if (pendingOrderStr) {
            const pendingOrder = JSON.parse(pendingOrderStr);
            if (pendingOrder.orderId === paymentData.orderId) {
                applicationData = pendingOrder.applicationData;
                console.log('‚úÖ Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÏÑú Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®');
            }
        }
        
        // FirebaseÏóêÏÑú Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏÉâ (Î∞±ÏóÖ)
        if (!applicationData && window.dbService) {
            const searchResult = await window.dbService.getDocuments('pending_applications', {
                where: { field: 'applicationId', operator: '==', value: paymentData.orderId }
            });
            
            if (searchResult.success && searchResult.data.length > 0) {
                applicationData = searchResult.data[0];
                console.log('‚úÖ FirebaseÏóêÏÑú Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®');
            }
        }
        
        if (!applicationData) {
            throw new Error('Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        }
        
        // Í≤∞Ï†ú Ï†ïÎ≥¥Î°ú Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        const updatedData = {
            ...applicationData,
            payment: {
                ...paymentData,
                status: 'completed',
                paidAt: new Date(),
                paymentMethod: 'toss_payments',
                pgProvider: 'tosspayments'
            },
            status: 'payment_completed',
            completedAt: new Date().toISOString(),
            
            displayInfo: {
                courseName: applicationData.courseInfo?.courseName || 'ÍµêÏú°Í≥ºÏ†ï',
                certificateType: applicationData.courseInfo?.certificateType || '',
                applicantName: applicationData.applicantInfo?.['applicant-name'] || 'Í≥†Í∞ù',
                totalAmount: paymentData.totalAmount || paymentData.amount,
                paymentDate: new Date().toISOString(),
                enrollmentStatus: 'enrolled',
                nextSteps: [
                    'ÍµêÏú° ÏãúÏûë Ï†Ñ ÏïàÎÇ¥ Î¨∏Ïûê Î∞úÏÜ°',
                    'Ïò®ÎùºÏù∏ Í∞ïÏùò ÏûêÎ£å Ï†ëÍ∑º Í∂åÌïú Î∂ÄÏó¨',
                    'ÍµêÏú° ÏàòÎ£å ÌõÑ ÏûêÍ≤©Ï¶ù Î∞úÍ∏â ÏßÑÌñâ'
                ]
            }
        };
        
        // FirebaseÏóê ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        if (window.dbService) {
            try {
                const result = await window.dbService.addDocument('applications', updatedData);
                if (result.success) {
                    updatedData.firestoreId = result.id;
                    console.log('‚úÖ Í≤∞Ï†ú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ:', result.id);
                }
            } catch (dbError) {
                console.error('‚ùå Firebase Ï†ÄÏû• Ïò§Î•ò:', dbError);
                // Firebase Ï†ÄÏû• Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
            }
        }
        
        // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏÑ±Í≥µ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        try {
            const recentApplications = JSON.parse(localStorage.getItem('dhc_recent_applications') || '[]');
            const newApplication = {
                applicationId: updatedData.applicationId,
                type: 'course_enrollment',
                courseName: updatedData.displayInfo.courseName,
                applicantName: updatedData.displayInfo.applicantName,
                totalAmount: updatedData.displayInfo.totalAmount,
                status: 'payment_completed',
                timestamp: new Date().toISOString(),
                paymentKey: paymentData.paymentKey,
                orderId: paymentData.orderId
            };
            
            recentApplications.unshift(newApplication);
            if (recentApplications.length > 10) {
                recentApplications.splice(10);
            }
            
            localStorage.setItem('dhc_recent_applications', JSON.stringify(recentApplications));
            
            // ÏûÑÏãú Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
            localStorage.removeItem('dhc_pending_order');
            localStorage.removeItem('dhc_payment_backup');
            
            console.log('‚úÖ Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            
        } catch (localError) {
            console.warn('‚ö†Ô∏è Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', localError);
        }
        
        // ÏóÖÎç∞Ïù¥Ìä∏Îêú Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
        applicationData = updatedData;
        
    } catch (error) {
        console.error('‚ùå Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
        throw error;
    }
}

// =================================
// UI ÏóÖÎç∞Ïù¥Ìä∏
// =================================

/**
 * ÏÑ±Í≥µ Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú
 */
function showSuccessResult() {
    try {
        console.log('üéâ ÏÑ±Í≥µ Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú');
        
        // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
        document.getElementById('loading-container').classList.add('hidden');
        
        // ÏÑ±Í≥µ ÌôîÎ©¥ ÌëúÏãú
        document.getElementById('success-container').classList.remove('hidden');
        
        // Í≤∞Ï†ú Ï†ïÎ≥¥ ÌëúÏãú
        updatePaymentInfo();
        
        console.log('‚úÖ ÏÑ±Í≥µ ÌôîÎ©¥ ÌëúÏãú ÏôÑÎ£å');
        
    } catch (error) {
        console.error('‚ùå ÏÑ±Í≥µ ÌôîÎ©¥ ÌëúÏãú Ïò§Î•ò:', error);
        showError('ÌôîÎ©¥ ÌëúÏãú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
}

/**
 * Í≤∞Ï†ú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
 */
function updatePaymentInfo() {
    try {
        const formatCurrency = (amount) => {
            return window.formatters?.formatCurrency 
                ? window.formatters.formatCurrency(amount)
                : `${amount.toLocaleString()}Ïõê`;
        };
        
        const formatDate = (date) => {
            if (window.formatters?.formatDate) {
                return window.formatters.formatDate(new Date(date), 'YYYY-MM-DD HH:mm');
            }
            return new Date(date).toLocaleString('ko-KR');
        };
        
        // Ï£ºÎ¨∏Î≤àÌò∏
        const orderIdElement = document.getElementById('order-id');
        if (orderIdElement && paymentData) {
            orderIdElement.textContent = paymentData.orderId || '-';
        }
        
        // ÍµêÏú°Í≥ºÏ†ïÎ™Ö
        const courseNameElement = document.getElementById('course-name');
        if (courseNameElement && applicationData) {
            courseNameElement.textContent = applicationData.displayInfo?.courseName || 'ÍµêÏú°Í≥ºÏ†ï';
        }
        
        // Ïã†Ï≤≠ÏûêÎ™Ö
        const customerNameElement = document.getElementById('customer-name');
        if (customerNameElement && applicationData) {
            customerNameElement.textContent = applicationData.displayInfo?.applicantName || 'Í≥†Í∞ù';
        }
        
        // Í≤∞Ï†úÍ∏àÏï°
        const paymentAmountElement = document.getElementById('payment-amount');
        if (paymentAmountElement && paymentData) {
            const amount = paymentData.totalAmount || paymentData.amount || 0;
            paymentAmountElement.textContent = formatCurrency(amount);
        }
        
        // Í≤∞Ï†úÎ∞©Î≤ï
        const paymentMethodElement = document.getElementById('payment-method');
        if (paymentMethodElement && paymentData) {
            const methodMap = {
                'Ïπ¥Îìú': 'Ïã†Ïö©Ïπ¥Îìú',
                'Í≥ÑÏ¢åÏù¥Ï≤¥': 'Í≥ÑÏ¢åÏù¥Ï≤¥',
                'Í∞ÄÏÉÅÍ≥ÑÏ¢å': 'Í∞ÄÏÉÅÍ≥ÑÏ¢å'
            };
            const method = paymentData.method || paymentData.type || 'Ïπ¥Îìú';
            paymentMethodElement.textContent = methodMap[method] || method;
        }
        
        // Í≤∞Ï†úÏùºÏãú
        const paymentDateElement = document.getElementById('payment-date');
        if (paymentDateElement && paymentData) {
            const date = paymentData.approvedAt || paymentData.requestedAt || new Date();
            paymentDateElement.textContent = formatDate(date);
        }
        
        console.log('‚úÖ Í≤∞Ï†ú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        
    } catch (error) {
        console.error('‚ùå Í≤∞Ï†ú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
    }
}

/**
 * Ïò§Î•ò ÌôîÎ©¥ ÌëúÏãú
 */
function showError(message) {
    console.log('‚ùå Ïò§Î•ò ÌôîÎ©¥ ÌëúÏãú:', message);
    
    // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
    document.getElementById('loading-container').classList.add('hidden');
    
    // Ïò§Î•ò ÌôîÎ©¥ ÌëúÏãú
    const errorContainer = document.getElementById('error-container');
    const errorMessageElement = document.getElementById('error-message');
    
    if (errorContainer) {
        errorContainer.classList.remove('hidden');
    }
    
    if (errorMessageElement) {
        errorMessageElement.textContent = message;
    }
}

// =================================
// Ïï°ÏÖò Ìï®ÏàòÎì§
// =================================

/**
 * ÎßàÏù¥ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
 */
function goToMyPage() {
    try {
        console.log('üìç ÎßàÏù¥ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô');
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ Íµ¨ÏÑ±
        const params = new URLSearchParams({
            from: 'payment_success',
            type: 'course_enrollment',
            highlight: 'latest'
        });
        
        if (applicationData?.applicationId) {
            params.set('applicationId', applicationData.applicationId);
        }
        
        if (applicationData?.displayInfo?.courseName) {
            params.set('courseName', applicationData.displayInfo.courseName);
        }
        
        // ÏàòÍ∞ï ÎÇ¥Ïó≠ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        const mypageUrl = window.adjustPath 
            ? window.adjustPath(`pages/mypage/course-history.html?${params.toString()}`)
            : `../mypage/course-history.html?${params.toString()}`;
            
        window.location.href = mypageUrl;
        
    } catch (error) {
        console.error('‚ùå ÎßàÏù¥ÌéòÏù¥ÏßÄ Ïù¥Îèô Ïò§Î•ò:', error);
        // Ìè¥Î∞±: ÌååÎùºÎØ∏ÌÑ∞ ÏóÜÏù¥ Ïù¥Îèô
        const fallbackUrl = window.adjustPath 
            ? window.adjustPath('pages/mypage/course-history.html')
            : '../mypage/course-history.html';
        window.location.href = fallbackUrl;
    }
}

/**
 * ÏòÅÏàòÏ¶ù Îã§Ïö¥Î°úÎìú
 */
async function downloadReceipt() {
    try {
        console.log('üßæ ÏòÅÏàòÏ¶ù Îã§Ïö¥Î°úÎìú');
        
        if (!paymentData || !applicationData) {
            alert('Í≤∞Ï†ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏñ¥ ÏòÅÏàòÏ¶ùÏùÑ Îã§Ïö¥Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
            return;
        }
        
        // ÏòÅÏàòÏ¶ù HTML ÏÉùÏÑ±
        const receiptHtml = generateReceiptHtml();
        
        // PDF ÏÉùÏÑ± (jsPDF ÏÇ¨Ïö© - CDNÏóêÏÑú Î°úÎìú)
        const { jsPDF } = window.jspdf || {};
        
        if (jsPDF) {
            const pdf = new jsPDF();
            pdf.html(receiptHtml, {
                callback: function(doc) {
                    const filename = `ÏòÅÏàòÏ¶ù_${paymentData.orderId}_${new Date().getTime()}.pdf`;
                    doc.save(filename);
                },
                x: 10,
                y: 10,
                width: 180,
                windowWidth: 800
            });
        } else {
            // jsPDFÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏÉà Ï∞ΩÏóêÏÑú Ï∂úÎ†•
            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptHtml);
            printWindow.document.close();
            printWindow.print();
        }
        
    } catch (error) {
        console.error('‚ùå ÏòÅÏàòÏ¶ù Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
        alert('ÏòÅÏàòÏ¶ù Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
}

/**
 * ÏòÅÏàòÏ¶ù HTML ÏÉùÏÑ±
 */
function generateReceiptHtml() {
    const formatCurrency = (amount) => `${amount.toLocaleString()}Ïõê`;
    const formatDate = (date) => new Date(date).toLocaleString('ko-KR');
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>ÏòÅÏàòÏ¶ù</title>
            <style>
                body { font-family: 'Noto Sans KR', sans-serif; margin: 20px; }
                .receipt { max-width: 600px; margin: 0 auto; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
                .company-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                .receipt-title { font-size: 20px; color: #666; }
                .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .info-table th, .info-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
                .info-table th { background-color: #f8f9fa; font-weight: bold; }
                .total-row { background-color: #e3f2fd; font-weight: bold; }
                .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="header">
                    <div class="company-name">Î¨∏Í≤Ω Î∂ÄÏÑ§ ÎîîÏßÄÌÑ∏Ìó¨Ïä§ÏºÄÏñ¥ÏÑºÌÑ∞</div>
                    <div class="receipt-title">Í≤∞Ï†ú ÏòÅÏàòÏ¶ù</div>
                </div>
                
                <table class="info-table">
                    <tr>
                        <th>Ï£ºÎ¨∏Î≤àÌò∏</th>
                        <td>${paymentData.orderId || '-'}</td>
                    </tr>
                    <tr>
                        <th>ÍµêÏú°Í≥ºÏ†ï</th>
                        <td>${applicationData.displayInfo?.courseName || '-'}</td>
                    </tr>
                    <tr>
                        <th>Ïã†Ï≤≠Ïûê</th>
                        <td>${applicationData.displayInfo?.applicantName || '-'}</td>
                    </tr>
                    <tr>
                        <th>Í≤∞Ï†úÎ∞©Î≤ï</th>
                        <td>${paymentData.method || paymentData.type || 'Ïπ¥Îìú'}</td>
                    </tr>
                    <tr>
                        <th>Í≤∞Ï†úÏùºÏãú</th>
                        <td>${formatDate(paymentData.approvedAt || new Date())}</td>
                    </tr>
                    <tr class="total-row">
                        <th>Í≤∞Ï†úÍ∏àÏï°</th>
                        <td>${formatCurrency(paymentData.totalAmount || paymentData.amount || 0)}</td>
                    </tr>
                </table>
                
                <div class="footer">
                    <p>Ïù¥ ÏòÅÏàòÏ¶ùÏùÄ Ï†ÑÏûêÏÉÅÍ±∞ÎûòÎ≤ïÏóê ÏùòÌïú Ï†ïÏãù ÏòÅÏàòÏ¶ùÏûÖÎãàÎã§.</p>
                    <p>Î¨∏ÏùòÏÇ¨Ìï≠: 010-2596-2233 | nhohs1507@gmail.com</p>
                </div>
            </div>
        </body>
        </html>
    `;
}

/**
 * ÌôàÏúºÎ°ú Ïù¥Îèô
 */
function goToHome() {
    console.log('üè† ÌôàÏúºÎ°ú Ïù¥Îèô');
    const homeUrl = window.adjustPath ? window.adjustPath('index.html') : '../../index.html';
    window.location.href = homeUrl;
}

/**
 * Í≥†Í∞ùÏÑºÌÑ∞ Î¨∏Ïùò
 */
function contactSupport() {
    console.log('üìû Í≥†Í∞ùÏÑºÌÑ∞ Î¨∏Ïùò');
    
    const message = `Í≤∞Ï†ú Í¥ÄÎ†® Î¨∏ÏùòÏÇ¨Ìï≠Ïù¥ ÏûàÏäµÎãàÎã§.\n\n` +
                   `Ï£ºÎ¨∏Î≤àÌò∏: ${paymentData?.orderId || 'Ïïå Ïàò ÏóÜÏùå'}\n` +
                   `Í≤∞Ï†úÏùºÏãú: ${new Date().toLocaleString()}\n` +
                   `Î¨∏ÏùòÎÇ¥Ïö©: `;
    
    // Ïù¥Î©îÏùº ÎòêÎäî Ï†ÑÌôî Ïó∞Í≤∞
    const email = 'nhohs1507@gmail.com';
    const subject = '[Í≤∞Ï†úÎ¨∏Ïùò] ' + (paymentData?.orderId || 'Í≤∞Ï†úÍ¥ÄÎ†®Î¨∏Ïùò');
    
    const mailtoUrl = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
    
    // Ïù¥Î©îÏùº ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó¥Í∏∞ ÏãúÎèÑ
    try {
        window.location.href = mailtoUrl;
    } catch (error) {
        // Ïù¥Î©îÏùº ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ï†ÑÌôîÎ≤àÌò∏ ÌëúÏãú
        alert('Í≥†Í∞ùÏÑºÌÑ∞ Ïó∞ÎùΩÏ≤ò:\nÏ†ÑÌôî: 010-2596-2233\nÏù¥Î©îÏùº: nhohs1507@gmail.com');
    }
}

/**
 * Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
 */
function goToPaymentPage() {
    console.log('üí≥ Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞');
    const paymentUrl = window.adjustPath 
        ? window.adjustPath('pages/education/course-application.html')
        : '../education/course-application.html';
    window.location.href = paymentUrl;
}

// =================================
// Ï†ÑÏó≠ Ìï®Ïàò ÎÖ∏Ï∂ú
// =================================

// Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú (HTMLÏóêÏÑú Ìò∏Ï∂ú)
window.goToMyPage = goToMyPage;
window.downloadReceipt = downloadReceipt;
window.goToHome = goToHome;
window.contactSupport = contactSupport;
window.goToPaymentPage = goToPaymentPage;

// =================================
// ÎîîÎ≤ÑÍπÖ ÎèÑÍµ¨
// =================================

if (window.location.hostname === 'localhost' || 
    window.location.hostname === '127.0.0.1' ||
    window.location.hostname.includes('.web.app')) {
    
    window.debugPaymentSuccess = {
        showPaymentData: () => {
            console.log('üí≥ Í≤∞Ï†ú Îç∞Ïù¥ÌÑ∞:', paymentData);
            console.log('üìÑ Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞:', applicationData);
        },
        
        testReceipt: () => {
            if (paymentData && applicationData) {
                downloadReceipt();
            } else {
                console.log('‚ùå Í≤∞Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
            }
        },
        
        simulateError: (message = 'ÌÖåÏä§Ìä∏ Ïò§Î•ò') => {
            showError(message);
        },
        
        simulateSuccess: () => {
            // ÌÖåÏä§Ìä∏Ïö© Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
            paymentData = {
                paymentKey: 'test_payment_' + Date.now(),
                orderId: 'TEST_' + Date.now(),
                amount: 50000,
                totalAmount: 50000,
                method: 'Ïπ¥Îìú',
                approvedAt: new Date().toISOString()
            };
            
            applicationData = {
                applicationId: paymentData.orderId,
                courseInfo: {
                    courseName: 'ÌÖåÏä§Ìä∏ ÍµêÏú°Í≥ºÏ†ï'
                },
                applicantInfo: {
                    'applicant-name': 'ÌôçÍ∏∏Îèô'
                },
                displayInfo: {
                    courseName: 'ÌÖåÏä§Ìä∏ ÍµêÏú°Í≥ºÏ†ï',
                    applicantName: 'ÌôçÍ∏∏Îèô',
                    totalAmount: 50000
                }
            };
            
            showSuccessResult();
            console.log('‚úÖ ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ ÌôîÎ©¥ ÌëúÏãúÎê®');
        },
        
        help: () => {
            console.log('üéØ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄ ÎîîÎ≤ÑÍπÖ ÎèÑÍµ¨');
            console.log('üìä Îç∞Ïù¥ÌÑ∞: showPaymentData()');
            console.log('üßæ ÏòÅÏàòÏ¶ù: testReceipt()');
            console.log('‚ùå Ïò§Î•ò: simulateError("Î©îÏãúÏßÄ")');
            console.log('‚úÖ ÏÑ±Í≥µ: simulateSuccess()');
        }
    };
    
    console.log('üéØ Í∞úÎ∞ú Î™®Îìú - Í≤∞Ï†ú ÏÑ±Í≥µ ÎîîÎ≤ÑÍπÖ ÎèÑÍµ¨ ÌôúÏÑ±ÌôîÎê®');
    console.log('üí° ÎèÑÏõÄÎßê: window.debugPaymentSuccess.help()');
}

// =================================
// ÏôÑÎ£å Î©îÏãúÏßÄ
// =================================

console.log('‚úÖ Í≤∞Ï†ú ÏÑ±Í≥µ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎî© ÏôÑÎ£å');