rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // í—¬í¼ í•¨ìˆ˜: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // í—¬í¼ í•¨ìˆ˜: ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    function isAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email == 'gostepexercise@gmail.com');
    }
    
    // í—¬í¼ í•¨ìˆ˜: íŒŒì¼ ì†Œìœ ì í™•ì¸
    function isOwner() {
      return isAuthenticated() && 
        request.auth.uid == resource.metadata.uploadedBy;
    }
    
    // í—¬í¼ í•¨ìˆ˜: í—ˆìš©ëœ íŒŒì¼ íƒ€ì… í™•ì¸
    function isValidFileType() {
      return resource.contentType.matches('image/.*') ||
             resource.contentType.matches('application/pdf') ||
             resource.contentType.matches('application/msword') ||
             resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
             resource.contentType.matches('application/vnd.ms-excel') ||
             resource.contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ||
             resource.contentType.matches('application/vnd.ms-powerpoint') ||
             resource.contentType.matches('application/vnd.openxmlformats-officedocument.presentationml.presentation') ||
             resource.contentType.matches('text/.*') ||
             resource.contentType.matches('video/.*');
    }
    
    // í—¬í¼ í•¨ìˆ˜: íŒŒì¼ í¬ê¸° í™•ì¸ (10MB ì œí•œ)
    function isValidFileSize() {
      return resource.size < 10 * 1024 * 1024;
    }
    
    // =================================
    // ğŸ”§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ Storage ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ê·œì¹™ ì¶”ê°€
    // =================================
    
    // ì¸ì¦ì„œ/ìê²©ì¦ íŒŒì¼ í´ë” (ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ìº”)
    match /certificates/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && isValidFileType() && isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // í”„ë¡œí•„ íŒŒì¼ í´ë” (ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ìº”)
    match /profiles/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidFileType() && isValidFileSize();
      allow delete: if isOwner() || isAdmin();
    }
    
    // êµìœ¡ ìë£Œ í´ë” (ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ìº”)
    match /materials/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && isValidFileType() && isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ë™ì˜ìƒ ê°•ì˜ í´ë” (ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ìº”)
    match /videos/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && isValidFileType() && isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ì¼ë°˜ ì—…ë¡œë“œ í´ë” (ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ìº”)
    match /uploads/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidFileType() && isValidFileSize();
      allow delete: if isOwner() || isAdmin();
    }
    
    // =================================
    // ê¸°ì¡´ ì„¸ë¶€ì ì¸ ê·œì¹™ë“¤ (ìœ ì§€)
    // =================================
    
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
    match /profile-images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (request.auth.uid == userId || isAdmin()) &&
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isOwner() || isAdmin();
    }
    
    // êµìœ¡ ìë£Œ íŒŒì¼ (ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
    match /course-materials/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ë™ì˜ìƒ ê°•ì˜ íŒŒì¼ (ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
    match /video-lectures/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼
    match /notice-attachments/{noticeId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ì¹¼ëŸ¼ ì²¨ë¶€íŒŒì¼
    match /column-attachments/{columnId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ê°•ì‚¬ í”„ë¡œí•„ ì´ë¯¸ì§€
    match /instructor-images/{instructorId}/{allPaths=**} {
      allow read: if true; // ê³µê°œì ìœ¼ë¡œ ì½ê¸° ê°€ëŠ¥
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ì„ì‹œ ì—…ë¡œë“œ í´ë” (1ì‹œê°„ í›„ ìë™ ì‚­ì œ)
    match /temp-uploads/{userId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && 
                           request.auth.uid == userId &&
                           isValidFileType() && 
                           isValidFileSize();
      allow delete: if isOwner() || isAdmin();
    }
    
    // ê²°ì œ ì˜ìˆ˜ì¦ íŒŒì¼
    match /payment-receipts/{userId}/{allPaths=**} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }
    
    // ì‹œí—˜ ê´€ë ¨ íŒŒì¼
    match /exam-files/{examId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() && 
                      isValidFileType() && 
                      isValidFileSize();
      allow delete: if isAdmin();
    }

    // ìê²©ì¦ ì‹ ì²­/ê°±ì‹  ì²¨ë¶€íŒŒì¼
    match /applications/{applicationId}/{allPaths=**} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();
      
      // ì“°ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì (íŒŒì¼ ì—…ë¡œë“œ)
      allow write: if isAuthenticated() && 
                      // PDF, ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš©
                      (request.resource.contentType.matches('application/pdf') ||
                       request.resource.contentType.matches('image/.*')) &&
                      // íŒŒì¼ í¬ê¸° ì œí•œ (5MB)
                      request.resource.size < 5 * 1024 * 1024;
      
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow delete: if isAdmin();
    }
    
    // ì‚¬ìš©ìë³„ ì„ì‹œ ì—…ë¡œë“œ í´ë” (ìê²©ì¦ ì‹ ì²­ìš©)
    match /temp-applications/{userId}/{allPaths=**} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin());
      
      // ì“°ê¸°: ë³¸ì¸ë§Œ ê°€ëŠ¥
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      (request.resource.contentType.matches('application/pdf') ||
                       request.resource.contentType.matches('image/.*')) &&
                      request.resource.size < 5 * 1024 * 1024;
      
      // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isAuthenticated() && 
                       (request.auth.uid == userId || isAdmin());
    }
    
    // ê²Œì‹œíŒ ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ìœ„í•œ ê·œì¹™ - ê° ê²Œì‹œíŒ íƒ€ì…ë³„ ê·œì¹™
    match /notice_images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isAdmin() || request.auth.uid == userId) &&
                      request.resource.contentType.matches('image/.*') && 
                      request.resource.size < 10 * 1024 * 1024;
      allow delete: if isAdmin() || request.auth.uid == userId;
    }
    
    match /column_images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isAdmin() || request.auth.uid == userId) &&
                      request.resource.contentType.matches('image/.*') && 
                      request.resource.size < 10 * 1024 * 1024;
      allow delete: if isAdmin() || request.auth.uid == userId;
    }
    
    match /materials_images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isAdmin() || request.auth.uid == userId) &&
                      request.resource.contentType.matches('image/.*') && 
                      request.resource.size < 10 * 1024 * 1024;
      allow delete: if isAdmin() || request.auth.uid == userId;
    }
    
    match /videos_images/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isAdmin() || request.auth.uid == userId) &&
                      request.resource.contentType.matches('image/.*') && 
                      request.resource.size < 10 * 1024 * 1024;
      allow delete: if isAdmin() || request.auth.uid == userId;
    }
    
    // =================================
    // ğŸ”§ ê´€ë¦¬ì ì „ìš© Storage ê´€ë¦¬ ê·œì¹™ (ëª¨ë“  í´ë” ìŠ¤ìº” í—ˆìš©)
    // =================================
    
    // ê´€ë¦¬ìëŠ” ëª¨ë“  íŒŒì¼ê³¼ í´ë”ì— ì½ê¸° ê¶Œí•œ (ëŒ€ì‹œë³´ë“œ ëª¨ë‹ˆí„°ë§ìš©)
    match /{allPaths=**} {
      // ê´€ë¦¬ìëŠ” ëª¨ë“  íŒŒì¼ ì½ê¸° ê°€ëŠ¥ (ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ìš©)
      allow read: if isAdmin();
      
      // ì¼ë°˜ ì‚¬ìš©ìì™€ ê´€ë¦¬ì ì™¸ì—ëŠ” ì ‘ê·¼ ë¶ˆê°€
      allow write: if false;
    }
  }
}